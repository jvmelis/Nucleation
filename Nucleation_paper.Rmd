---
title: "Nucleation Experiment"
author: "Holl et al."
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-location: left
    toc_depth: 3
    code-tools:
      source: true
      toggle: false
      caption: none
    code-fold: true
    code-summary: "show code"
editor: source
self-contained: true
always_allow_html: true
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
```

# After first submission

  * Data and R codes available: [github](https://github.com/jvmelis/Nucleation), then it will be submited to [zenodo](https://zenodo.org)

  * Inclusion of species diversity of recruiting plants: item [I.C](#c-recruitment), with rarefaction and Proportion of Biotic/Abiotic Seed Dispersal and  Planted/Unplanted species.
  
  * Table with statistical details from the models (file `"itatinga_NUC_ModelSummaries.xlsx"`)

  * Fixed LiDAR figure (SE of the mean)
  
  * Fixed plots with empty recruits
  
  * Considering only small recruits in species richness rarefaction curves
  
  * Analyses separating Baccharis + Vernonanthura
  
  

#  Setup environment

## 1) R Environment

```{r path}
path <- getwd()
version
```

```{r packages}
if(!require(pacman)){install.packages("pacman")}
pkg_list <-c("tidyverse", "lme4", "DHARMa", "emmeans", "multcomp", "iNEXT",
             "car", "performance", "cowplot", "MuMIn", "ggpattern")
pacman::p_load(pkg_list, character.only = TRUE)
```


## 2) Read data

`trees_clean`: data of trees (planted/not-planted)

```{r}
trees_clean <- readxl::read_xlsx(paste0(path, "/Itatinga_Nuc_trees.xlsx"))
trees_clean <- trees_clean |>
  dplyr::mutate(scientificName = dplyr::if_else(is.na(scientificName), "Unclassified", scientificName))
```

`grass_cover`: grass cover per plot (%)

```{r}
grass_cover <- readxl::read_xlsx(paste0(path, "/Itatinga_Nuc_grasscover.xlsx"))
```

`lidar`: Canopy Height Metric (`CHM_mean`, `CHM_SD`, and `CHM_CV`), Canopy cover (`Canopy_cover`), Rugosity (`Rugosity_SD`, and `Rugosity_CV`), Leaf Area Index (`LAI_mean`, `LAI_SD`, and `LAI_CV`), and LAIunder (`LAIunder_mean`, `LAIunder_SD`, `LAIunder_CV`).

```{r}
lidar2022_wide <- readxl::read_xlsx(
  paste0(path, "/tab_metrics_LiDAR_2022_v2.xlsx")) |>
  dplyr::select(Trat:LAIunder_SD) |>
  tidyr::separate(Trat, into = c("Bloco", "Perc_cobertura","Tratamento"), sep = "_") |>
  dplyr::mutate(Tratamento = dplyr::if_else(is.na(Tratamento), "controle", Tratamento),
                Tratamento = paste(Perc_cobertura, Tratamento, sep="_"),
                ano =  2022) |>
  dplyr::select(-Perc_cobertura) 
lidar2024_wide <- readxl::read_xlsx(
  paste0(path, "/tab_metrics_LiDAR_2024_v2.xlsx"))|>
  dplyr::select(Trat:LAIunder_SD) |>
  tidyr::separate(Trat, into = c("Bloco", "Perc_cobertura","Tratamento"), sep = "_") |>
  dplyr::mutate(Tratamento = dplyr::if_else(is.na(Tratamento), "controle", Tratamento),
                Tratamento = paste(Perc_cobertura, Tratamento, sep="_"),
                ano =  2024) |>
  dplyr::select(-Perc_cobertura)

lidar_wide <- dplyr::bind_rows(lidar2022_wide, lidar2024_wide) |> # 40 x 12
   dplyr::mutate(
     Tratamento = factor(Tratamento, 
                         levels = c("25_tabuleiro", "25_faixa",  "50_tabuleiro", "50_faixa", "100_controle"),
                         labels = c("Nuclei 25%", "Strips 25%", "Nuclei 50%", "Strips 50%", "Planting 100%")))

```

#### Table - List of sampled species (planted and recruits)

 two tables: 


```{r}
trees_clean |> dplyr::select(RP, family, scientificName) |>
  unique()|>
  dplyr::mutate(valor=TRUE)|>
  tidyr::pivot_wider(names_from = RP, values_from = valor, values_fill = FALSE) |>
  dplyr::arrange(desc(planted), family, scientificName) # |> writexl::write_xlsx("tab1.xlsx")

trees_clean |> dplyr::select(RP, family, scientificName) |>
  unique() |> with(table(RP))
```


# I. Results - Field data

## A) Survival of planted trees

### (i) Organizing data

```{r}
trees_clean |> with(table(RP, scientificName)) |>
  as.data.frame() |> 
  dplyr::filter(Freq>0) |> # writexl::write_xlsx("tab_spp_plantio.xlsx")
  dplyr::filter(RP=="planted")
```

Reading scientific names

```{r}
survival_planted2024 <- trees_clean |> # 5416 stems
  dplyr::filter(ano==2024)|> 
  dplyr::select(bloco:arv, Hm, scientificName, RP) |> # 3,199 stems
  unique() |> # 1487
  dplyr::filter(RP=="planted") |> # 1135
  dplyr::group_by(tratamento,bloco, parcela)|>
  dplyr::summarise(n = dplyr::n(), .groups = "drop")|>
  dplyr::arrange(desc(n))
```

### (ii) Survival analysis

24 seedlings per plot

```{r}
survival_planted2024 |>
  with(table(bloco, parcela, by=tratamento))
survival_planted2024 |> dplyr::arrange(tratamento, bloco, parcela)
mod_surv1 <- lme4::glmer(cbind(n, 24 - n) ~ tratamento + (1|bloco), data = survival_planted2024, family = binomial(link = "logit"))
mod_surv_null <- lme4::glmer(cbind(n, 24 - n) ~ 0 +(1|bloco), data=survival_planted2024, family = binomial(link = "logit"))
AIC(mod_surv1, mod_surv_null)
```

```{r}
par(mfrow=c(1,2))
DHARMa::plotResiduals(mod_surv1)
DHARMa::plotQQunif(mod_surv1)
```

Marginal $R^2$ / Conditional $R^2$

```{r}
MuMIn::r.squaredGLMM(mod_surv1)
0.129/ 0.487
```

Which it is `r round(0.129/ 0.487, 3)`

```{r}
sjPlot::tab_model(mod_surv1)
broom.mixed::tidy(mod_surv1) |> dplyr::mutate(dplyr::across(4:7, round, 3)) 
summary(mod_surv1)
exp(-0.544)
(52.3/(100-52.3))/ (39.2/(100-39.2))
```

Planted trees in treatment `F25` have `r round((1 - exp(-0.222))*100,2)`% *less* likely to survive (`OR=exp(-0.222)`) than in treatment `100%` ($p<0.1$)

Planted trees in treatment `N25` have `r  round((1 - exp(-0.544))*100,2)`% *less* likely to survive (`OR=exp(-0.544)`) than in treatment `100%` ($p<0.001$)

```{r}
round((1 - exp(-0.544))*100,2)
emmeans::emmeans(mod_surv1, ~ tratamento, type = "response") |> 
  multcomp::cld(details = TRUE, adjust="sidak")
```

### (iii) Table S2 - Survival

```{r}
survival_planted2024 |>
  dplyr::group_by( tratamento)|>
  dplyr::summarise(Mean = round(mean((n/24)*100),1),
                  Max = round(max((n/24)*100),1),
                  Min = round(min((n/24)*100),1) ) |>
  dplyr::mutate(values = paste0(Mean," (",Min," - ",Max,")")) |>
  dplyr::select(-c(Mean, Max, Min)) 
```




## B) Grass cover

### (i)  Organizing data

How planting scheme affected grass cover inside and outside planted areas?

Excluding treatment `100`:

```{r}
ordem <- c("N25", "F25","N50", "F50", "100")
grass_cover <- readxl::read_xlsx(
  paste0(path, "/Itatinga_Nuc_grasscover.xlsx"))|>
  dplyr::mutate(
    grass_perc = dplyr::if_else(gramineas_perc>=1, 0.9999, gramineas_perc),
    tratamento = ordered(tratamento, 
                         levels = ordem,
                         labels = c("Nuclei 25%", "Strips 25%", "Nuclei 50%", "Strips 50%", "Planting 100%"))) |>
   droplevels()
grass_cover2024 <- grass_cover |> dplyr::filter(tratamento!="Planting 100%") |> dplyr::filter(ano==2024)
grass_cover2024 |>
  with(table(bloco, parcela, by=tratamento))
```

Too many zeros? Zero-Inflated model? There is few zeros. *Only binomial fit*

```{r}
grass_cover2024 |>
  ggplot(aes(x=grass_perc))+
  geom_histogram()+
  facet_grid(plantio~tratamento)+theme_classic()
```

### (ii) Analysis

```{r}
grass_cover2024 |>
  with(table(bloco, parcela, by=tratamento))
grass_cover2024 <-grass_cover2024 |>
  dplyr::mutate(Tratamento=factor(tratamento, ordered = FALSE))
modelo_gc24a <- glmmTMB::glmmTMB(grass_perc ~ Tratamento*plantio + (1 | bloco),
                        family = glmmTMB::beta_family(), data = grass_cover2024)
modelo_gc24b <- grass_cover2024 |> 
  dplyr::mutate(tratamento=factor(tratamento,ordered = FALSE))|>
  with(glmmTMB::glmmTMB(grass_perc ~ tratamento+plantio + (1 | bloco),
                   ziformula = ~ 1, family = glmmTMB::beta_family()))
modelo_gc24c <-  grass_cover2024 |> 
  dplyr::mutate(tratamento=factor(tratamento,ordered = FALSE))|>
  with(glmmTMB::glmmTMB(grass_perc ~ plantio + (1 | bloco), 
                                  family = glmmTMB::beta_family()))
modelo_gc24d <-  grass_cover2024 |> 
  dplyr::mutate(tratamento=factor(tratamento,ordered = FALSE))|>
  with(glmmTMB::glmmTMB(grass_perc ~ tratamento + (1 | bloco), 
                                  family = glmmTMB::beta_family()))
modelo_gc24null <-  grass_cover2024 |> 
  dplyr::mutate(tratamento=factor(tratamento,ordered = FALSE))|>
  with(glmmTMB::glmmTMB(grass_perc ~ 0 + (1 | bloco), 
                        family = glmmTMB::beta_family()))

AIC(modelo_gc24a, modelo_gc24b, modelo_gc24c, modelo_gc24d, modelo_gc24null)
```

Analysis of residuals

```{r}
par(mfrow=c(1,2))
DHARMa::plotQQunif(modelo_gc24a)
DHARMa::plotResiduals(modelo_gc24a)
```

Is there any difference between treatments considering inside/outside?

```{r}
resultado_24 <- emmeans::emmeans(modelo_gc24a, ~ Tratamento|plantio) |> 
  multcomp::cld( details = TRUE)
resultado_24$emmeans
```

**Answer:** yes.

Is there any difference between inside/outside considering treatments?

```{r}
resultado_24a <- emmeans::emmeans(modelo_gc24a, ~ plantio|Tratamento) |> 
  multcomp::cld(details = TRUE)
resultado_24a$emmeans
```

**Answer:** yes.

```{r}
broom.mixed::tidy(modelo_gc24a) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))|> knitr::kable()
sjPlot::tab_model(modelo_gc24a)
lme4::VarCorr(modelo_gc24a)  # ou summary(modelo_gc24a)$varcor
MuMIn::r.squaredGLMM(modelo_gc24a)
m_fix <- update(modelo_gc24a, . ~ . - (1|bloco))
anova(modelo_gc24a, m_fix) 
performance::check_singularity(modelo_gc24a)
```


### (iii) Figure - Grass cover

*Small letters*: Comparison between treatments, only inside planted areas. 

*Capital letters*: Comparison between treatments, only outside planted areas.


```{r, fig.width=3.54,fig.height=3.54}
letras <- data.frame(
  tratamento = rep(levels(as.factor(grass_cover$tratamento)),each=2),
  plantio = levels(as.factor(grass_cover$plantio)),
  label = c("BC      ", "      a",
            "AB      ", "      a",
            "C      ", "      a",
            "A      ", "      a",
            "A",""),  
  y = c(0.6, 0.82, 
        0.5, 0.8, 
        0.65, 0.8, 
        0.35, 0.8,
        0.35, .1)
  ) |>
  dplyr::mutate(
    tratamento = forcats::fct_recode(tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"
                                     )
  )

fig_grass <- grass_cover |>  
  dplyr::filter(ano==2024) |>
  dplyr::group_by(tratamento, plantio) |>
  dplyr::summarise(grass_cover_mean = mean(gramineas_perc),
                   sd = sd(gramineas_perc),
                   n = dplyr::n(),
                   se = sd/sqrt(n),
                   .groups="drop") |>
  dplyr::mutate(
    tratamento = forcats::fct_recode(tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"
                                     )
  ) |>
  ggplot(aes(x = tratamento, y = grass_cover_mean, fill = plantio)) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = grass_cover_mean - se, ymax = grass_cover_mean + se),
                width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(
    labels = c('Planted', 'Unplanted'), 
    values = c("#92D050", "white")) +
  geom_text(data = letras, aes(x = tratamento, y = y, label = label), size=4, vjust = -0.5) +
  labs(fill = "", 
       y = "Grass cover (%)",
       x = "") +
  scale_y_continuous(expand = c(0,0), 
                     labels = scales::percent_format(accuracy = 1), 
                     limits = c(0,1)) +
  theme_classic()+
  theme(
    axis.text.x = element_text(color="black", hjust = 0.5, size=11),
    axis.text.y = element_text(color="black", size=11),
    axis.title.y = element_text(color="black", size=13),
    legend.position = c(0.84, 0.99),
    legend.text = element_text(size = 11, margin = margin(0,0,0, l=1, "mm")),
    legend.key.size = unit(3, "mm"),
    legend.spacing = unit(0, "mm"),
    legend.background = element_blank())
fig_grass
# ggsave("fig_grass.png", plot=fig_grass, width=90, height = 90 ,unit="mm")
```



### (iv) Table S2 - Grass cover


```{r}
grass_cover |>
  dplyr::group_by(ano, tratamento, plantio)|>
  dplyr::summarise(Mean = mean(gramineas_perc)*100,
                  Max = max(gramineas_perc)*100,
                  Min = min(gramineas_perc)*100) |>
  dplyr::mutate(values = paste0(Mean," (",Min," - ",Max,")")) |>
  dplyr::select(-c(Mean, Max, Min)) |>
  tidyr::pivot_wider(names_from = tratamento, values_from = values)
```

## C) Recruitment

Only recruits (smaller and larger), not including planted individuals

```{r}
species_table <- readxl::read_xlsx("itatinga_Nuc_regen_species_abundance.xlsx")
species_table|>
  dplyr::select(Treatment, Block, Plot, Planted)|>
  unique()|>
  with(table(Block, Plot, by=Treatment))
```

Viewing top species

```{r}
total_smaller <- sum(species_table$n_sapling)
total_larger <- sum(species_table$n_tree)
species_table |>
  dplyr::group_by(scientificName)|>
  dplyr::summarise(
    sum_large = sum(n_tree, na.rm=T)/total_larger,
    sum_small = sum(n_sapling, na.rm=T)/total_smaller,
  )|>
  dplyr::arrange(desc(sum_small)) |>
  head()
```


### (i) Considering Baccharis + Vernonanthura


Only small regenerants

```{r}
dados_list <- species_table |>
  dplyr::group_by(Treatment, Planted, scientificName) |>
  dplyr::summarise(n_total = sum(n_sapling), .groups = "drop") |>
  dplyr::group_by(Treatment, Planted) |>
  dplyr::summarise(abundancias = list(n_total), .groups = "drop") |>
  dplyr::mutate(nome_grupo = paste(Treatment, Planted, sep = "_")) %>% 
  { setNames(.$abundancias, .$nome_grupo) }
res_inext <- iNEXT::iNEXT(
  dados_list,
  q = 0,
  size=seq(0, 2000, 100),
  datatype = "abundance"
)

estimativas <- res_inext$iNextEst |>
  dplyr::bind_rows() |>
  tidyr::separate(Assemblage, into = c("Treatment", "Percent", "Planted"), sep = "_")
```

#### Figure species richness

Figure Recruits' species richness

For Hill q = 0

Only small regenerants and considering ruderal species (*Vernonanthura* & *Baccharis*)

```{r, fig.height=8.26, fig.width=3.54}
dados_list <- species_table |>
  dplyr::group_by(Treatment, Planted, scientificName) |>
  dplyr::summarise(n_total = sum(n_sapling), .groups = "drop") |>
  dplyr::group_by(Treatment, Planted) |>
  dplyr::summarise(abundancias = list(n_total), .groups = "drop") |>
  dplyr::mutate(nome_grupo = paste(Treatment, Planted, sep = "_")) %>% 
  { setNames(.$abundancias, .$nome_grupo) }
res_inext <- iNEXT::iNEXT(
  dados_list,
  q = 0,
  size=seq(0, 2000, 100),
  datatype = "abundance"
)

estimativas <- res_inext$iNextEst |>
  dplyr::bind_rows() |>
  tidyr::separate(Assemblage, into = c("Treatment", "Percent", "Planted"), sep = "_")

curvas_df0 <- estimativas |> 
  dplyr::filter(Order.q==0)|> 
  dplyr::filter(!is.na(SC.LCL))|>
  dplyr::mutate(
    Percent = ifelse(Percent=="Planted", "100", Percent),
    Percent = ordered(Percent, levels = c("25", "50", "100")),
    Planted = ifelse(Planted=="Inside", "Planted", "Unplanted"),
    Treatment = ifelse(Treatment=="Full", "Planting 100%", Treatment),
    Treatment = factor(Treatment, levels = c("Nuclei", "Strip", "Planting 100%"), ordered = TRUE)
  ) 
fig_recruit_rich <- curvas_df0 |>
  ggplot(aes(x = m, y = qD, color = Treatment, linetype = Planted)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL, fill = Treatment), alpha = 0.2, colour = NA) +
   geom_point(
    data = dplyr::filter(curvas_df0, Method == "Observed"),
    size = 2.5
  ) +
  facet_grid(Percent~., 
             labeller =  as_labeller(
               c("25" = "(a) Planting 25%",
                 "50" = "(b) Planting 50%",
                 "100" = "(c) Planting 100%")
               )) +
  scale_color_manual(values=c("red", "blue", "darkgreen"))+
  scale_fill_manual(values=c("red", "blue", "darkgreen"))+
  labs(
    x = "Number of sampling units (regenerants)",
    y = "Species diversity (Hill Index, q=0)"
    ) +
  ggthemes::theme_clean()+
  scale_x_continuous(expand = c(0.001, 0), breaks = seq(0, 3500, 500)) +
  scale_y_continuous(expand = c(0, 0))+
  theme(
     panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(color = "black", hjust = 1, size = 10),
    axis.text.y = element_text(color = "black", size = 9),
    axis.title.y = element_text(color = "black", size = 11),
    strip.text = element_text(color = "black", hjust = 0.5, size = 10),
    strip.placement = "outside",
    legend.text = element_text(size = 11),
    legend.title = element_blank(),
    legend.key.size = unit(5, "mm"),
    legend.box.background = element_blank(),
    legend.box.margin = margin(t = 5, r = 0, b = 0, l = 0, "mm"),
    legend.background = element_blank(),
    legend.margin = margin(0, 0, 0, 0),
    legend.position = c(0.25, 0.25),
    panel.border = element_rect(colour = "black", fill = NA),
    panel.spacing = unit(0, "lines")
  )
fig_recruit_rich
# ggsave("fig_richness_all_small_recruits.png", plot=fig_recruit_rich, width=90, height = 210 ,unit="mm")
```



#### Table S2 - Recruitment (all)

Estimating Density of recruits ($ind.ha^{-1}$) and considering ruderal species (*Baccharis* and *Vernonanthura*)

```{r}
density_recruits_n_m2 <- species_table |> 
  dplyr::mutate(
    n_small = dplyr::if_else(is.na(n_sapling), 0, n_sapling),
    n_large = dplyr::if_else(is.na(n_tree), 0, n_tree)) |>
  dplyr::group_by(Treatment, Block, Planted) |>
  dplyr::summarise(
    n_small_m2 = (sum(n_small, na.rm=T))/(144*4), 
    n_large_m2 = (sum(n_large, na.rm=T))/(144*4), 
    .groups = "drop")

dens_ha <- density_recruits_n_m2 |>
  dplyr::mutate(
    n_small_ha = n_small_m2 * 10000,
    n_large_ha = n_large_m2 * 10000
  )
dens_P_UP <- dens_ha |>
  tidyr::pivot_wider(
    names_from = Planted,
    values_from = c(n_small_ha, n_large_ha),
    names_sep = "_"
  )

prop_table <- tidyr::tibble(
  Treatment = unique(sort(species_table$Treatment)),
  prop_P = c(1, 0.25, 0.5, 0.25, 0.5),
  prop_UP = 1 - prop_P
)

result_regenerant <- dens_P_UP |>
  dplyr::left_join(prop_table, by = "Treatment") |>
  dplyr::mutate(
    n_small_total_ha = dplyr::coalesce(n_small_ha_Inside * prop_P, 0)  + dplyr::coalesce(n_small_ha_Outside * prop_UP, 0),
    n_large_total_ha = dplyr::coalesce(n_large_ha_Inside * prop_P, 0) + dplyr::coalesce(n_large_ha_Outside * prop_UP, 0)
  ) |>
  dplyr::select(Treatment,
         starts_with("n_small_ha"),
         starts_with("n_large_ha"),
         n_small_total_ha,
         n_large_total_ha
  )
```


**Smaller recruits**

* Only in *planted* areas

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_ha_Inside, na.rm=TRUE),1),
    min = round(min(n_small_ha_Inside, na.rm=TRUE),0),
    max = round(max(n_small_ha_Inside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```

* Only in *unplanted* areas

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_ha_Outside, na.rm=TRUE), 1),
    min = round(min(n_small_ha_Outside, na.rm=TRUE), 0),
    max = round(max(n_small_ha_Outside, na.rm=TRUE), 0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* In *total* (planted + unplanted areas)


```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_total_ha, na.rm=TRUE),1),
    min = round(min(n_small_total_ha, na.rm=TRUE),0),
    max = round(max(n_small_total_ha, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


**Larger recruits**

All treatments and inside/outside areas showed similar values

* Only in *planted* areas

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_ha_Inside, na.rm=TRUE),1),
    min = round(min(n_large_ha_Inside, na.rm=TRUE),0),
    max = round(max(n_large_ha_Inside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* Only in *unplanted* areas

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_ha_Outside, na.rm=TRUE),1),
    min = round(min(n_large_ha_Outside, na.rm=TRUE),0),
    max = round(max(n_large_ha_Outside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* In *total* (planted + unplanted areas)


```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_total_ha, na.rm = TRUE), 1),
    min = round(min(n_large_total_ha, na.rm = TRUE), 0),
    max = round(max(n_large_total_ha, na.rm = TRUE), 0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```

#### Analysis for smaller recruits abundance

Data:

```{r}
small_df <- species_table |>
  dplyr::group_by(Treatment, Block, Plot, Planted)|>
  dplyr::summarise(n = sum(n_sapling), .groups="drop")

small_df |>
  ggplot(aes(x=Planted, y=n, color=Block))+
  geom_point()+facet_wrap(~Treatment)+theme_bw()
```


Models:


```{r}
modelo_reg1 <- glmmTMB::glmmTMB(n ~ Treatment*Planted + (1 | Block),
                   # family = poisson(),
                   family = glmmTMB::nbinom2(),
                   data = small_df)

modelo_reg2 <-  glmmTMB::glmmTMB(n ~ Treatment + (1 | Block),
                   # family = poisson(),
                   family = glmmTMB::nbinom2(),
                   data = small_df)
modelo_reg3 <-  glmmTMB::glmmTMB(n ~ Planted + (1 | Block),
                   # family = poisson(),
                   family = glmmTMB::nbinom2(),
                   data = small_df)
modelo_reg_null <-  glmmTMB::glmmTMB(n ~ 0 + (1 | Block),
                   # family = poisson(), # Poisson
                   family = glmmTMB::nbinom2(), # NB
                   data = small_df)

# NBinom 1782.688 (null) |	1734.985 (Treatment*Planted) | 1756.665	(only Treament) | 1743.097	(only Planted)
# Poisson  4032.177	|	3373.854		|	3813.769		|	3759.763

AIC(modelo_reg_null, modelo_reg1, modelo_reg2, modelo_reg3)
```

`non-positive-definite Hessian matrix`  indicates that there are problems in estimating the model parameters. This may be related to redundancies in the random effects, perfect separation, few data for some combinations of factors, or problems in choosing the distribution. Therefore, let's check the singularity:

```{r}
performance::check_singularity(modelo_reg1)
performance::check_model(modelo_reg1)
```

Exploring residuals

```{r, fig.width=10, fig.height=10}
par(mfrow=c(2,2))
DHARMa::plotResiduals(modelo_reg1)
DHARMa::plotQQunif(modelo_reg1)
DHARMa::plotResiduals(modelo_reg3)
DHARMa::plotQQunif(modelo_reg3)
```


```{r}
car::Anova(modelo_reg1)
```


Is there any difference between treatments considering only inside or outside?

```{r}
emmeans::emmeans(modelo_reg1, ~ Treatment|Planted) |> 
  multcomp::cld(adjust="bonferroni")
```

**Answer:** Yes (inside) and no (outside).

Is there any difference between treatments *not* considering inside/outside?

```{r}
emmeans::emmeans(modelo_reg2, ~ Treatment) |> 
    multcomp::cld(adjust="bonferroni")
```


**Answer:** No.

Is there any difference between inside/outside considering treatments?

```{r}
emmeans::emmeans(modelo_reg1, ~ Planted|Treatment) |> 
    multcomp::cld(adjust="bonferroni")
```

**Answer:** Yes.

#### Table S3

```{r}
sjPlot::tab_model(modelo_reg1)
broom.mixed::tidy(modelo_reg1) |>
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3))) |> dplyr::select(-c(group,component))
```


#### Analysis for larger recruits abundance

Data:

```{r}
large_regenerants_2024 <- species_table |>
  dplyr::group_by(Treatment, Block, Plot, Planted)|>
  dplyr::summarise(n = sum(n_tree), .groups="drop")
```

Plotting

```{r}
large_regenerants_2024 |>
  ggplot(aes(x=Planted, y=n, color=Block))+
  geom_point()+facet_wrap(~Treatment)+theme_bw()
```


Models

```{r}
modelo_reg1 <- glmmTMB::glmmTMB(n ~ Treatment*Planted + (1 | Block),
                   ziformula = ~1,
                    # family = poisson(),
                     family = glmmTMB::nbinom2(),
                    # family = glmmTMB::truncated_nbinom2(),
                   data = large_regenerants_2024)
modelo_reg2 <-  glmmTMB::glmmTMB(n ~ Treatment + (1 | Block),
                   ziformula = ~1,
                   #  family = poisson(),
                    family = glmmTMB::nbinom2(),
                  #  family = glmmTMB::truncated_nbinom2(),
                   data = large_regenerants_2024)
modelo_reg3 <-  glmmTMB::glmmTMB(n ~ Planted + (1 | Block),
                   ziformula = ~1,
                   # family = poisson(),
                    family = glmmTMB::nbinom2(),
                   #  family = glmmTMB::truncated_nbinom2(),
                   data = large_regenerants_2024)
modelo_reg_null <-  glmmTMB::glmmTMB(n ~ 0 + (1 | Block),
                   ziformula = ~1,
                    # family = poisson(), # ZIP
                     family = glmmTMB::nbinom2(), # ZINB
                    # family = glmmTMB::truncated_nbinom2(), # hurdle
                   data = large_regenerants_2024)
# Model (null) | (treat*planted) | (treat) | (planted)
# ZINB 885.72		|	869.63		 |	868.93	|	864.21
# ZIP  1058.14   | 1015.06		 |	1025.38	|	1024.49
# Hurdle 880.75	| 872.21		|	868.74		|	975.88

AIC(modelo_reg_null, modelo_reg1, modelo_reg2, modelo_reg3)
performance::check_model(modelo_reg1)
```


Exploring residuals

```{r}
par(mfrow=c(2,2))
DHARMa::plotResiduals(modelo_reg1)
DHARMa::plotQQunif(modelo_reg1)
DHARMa::plotResiduals(modelo_reg3)
DHARMa::plotQQunif(modelo_reg3)
```



```{r}
MuMIn::r.squaredGLMM(modelo_reg3)
# 0.03253385/0.03665597
```

0.0328/ 0.0338 variance explained by fixed effects and by the entire model (around `r 0.03380077/0.03380078` % is explained by fixed effects)


```{r}
performance::r2(modelo_reg1)

broom.mixed::tidy(modelo_reg1) |>
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3))) |>
  dplyr::select(-c(component, group))|>
  knitr::kable()
```

```{r}
car::Anova(modelo_reg1)
```



Is there any difference between treatments considering inside/outside?

```{r}
emmeans::emmeans(modelo_reg1, ~ Treatment|Planted) |> 
  multcomp::cld(adjust = "bonferroni")
```

**Answer:** No.

Is there any difference between inside/outside considering treatments?

```{r}
emmeans::emmeans(modelo_reg1, ~ Planted|Treatment) |> 
  multcomp::cld(adjust = "bonferroni")
```

**Answer:** No.



#### Propotion of smaller recruits from planted species


* With ruderal species

Getting proportions of planted/unplanted species

```{r}
prop_regenerant_full <- species_table |>
  dplyr::mutate(
    planted_tree = ifelse(`Planting group`=="NA", "No", "Yes"))|>
  dplyr::filter(n_sapling>0)|>
  dplyr::group_by(Treatment, Planted, Block, Plot) |>
  dplyr::summarise(
    n_species = dplyr::n(),
    n_ind = sum(n_sapling),
    n_planted_ind = sum(ifelse(planted_tree == "Yes", n_sapling, 0), na.rm = TRUE),
    n_planted_ind = ifelse(is.na(n_planted_ind), 0, n_planted_ind),
    n_planted_spp = sum(planted_tree == "Yes"), 
    n_planted_spp = ifelse(is.na(n_planted_spp), 0, n_planted_spp),
    .groups = "drop") |>
  dplyr::mutate(
    prop_planted_ind = n_planted_ind / n_ind,
    prop_planted_spp = n_planted_spp / n_species
  )

prop_regenerant_full |>
  dplyr::group_by(Treatment, Planted)|>
  dplyr::summarise(
    prop_planted_mean = mean(prop_planted_ind, na.rm=T),
    prop_planted_min = min(prop_planted_ind, na.rm=T),
    prop_planted_max = max(prop_planted_ind, na.rm=T),
    prop_planted_spp_mean = mean(prop_planted_spp, na.rm=T),
    prop_planted_spp_min = min(prop_planted_spp, na.rm=T),
    prop_planted_spp_max = max(prop_planted_spp, na.rm=T),
    .groups = "drop"
  ) |>
  dplyr::mutate(
    prop_planted = sprintf("%.1f (%.1f - %.1f)", 
                                round(prop_planted_mean,3)*100, 
                                round(prop_planted_min,3)*100, 
                                round(prop_planted_max,3)*100),
    prop_planted_spp = sprintf("%.1f (%.1f - %.1f)", 
                                    round(prop_planted_spp_mean,3)*100, 
                                    round(prop_planted_spp_min,3)*100, 
                                    round(prop_planted_spp_max,3)*100)
    ) |>
  dplyr::select(Treatment,Planted, prop_planted, prop_planted_spp) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = c(prop_planted, prop_planted_spp)
    ) # |> writexl::write_xlsx("resulta_prop_recruit.xlsx")
```

Statistical analysis



```{r}
mod_binomial_full <-lme4::glmer(
  cbind(n_planted_ind, n_ind - n_planted_ind) ~ Treatment*Planted + (1 | Block),
  family = binomial(link = "logit"),
  data = prop_regenerant_full)

performance::check_overdispersion(mod_binomial_full) # no
performance::check_model(mod_binomial_full)
DHARMa::plotResiduals(mod_binomial_full)

emmeans::emmeans(mod_binomial_full, pairwise ~ Treatment | Planted) |> multcomp::cld(adjust="sidak")
emmeans::emmeans(mod_binomial_full, pairwise ~  Planted | Treatment) |> multcomp::cld(adjust="sidak")
```


```{r}
broom.mixed::tidy(mod_binomial_full) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))
sjPlot::tab_model(mod_binomial_full)
```


### (ii) *Not* considering Baccharis + Vernonanthura

#### Figure species richness

Hill q = 0

Only small regenerants and considering ruderal species (*Vernonanthura* & *Baccharis*)

```{r}
dados_list <- species_table |>
  dplyr::filter(!scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  dplyr::group_by(Treatment, Planted, scientificName) |>
  dplyr::summarise(n_total = sum(n_sapling), .groups = "drop") |>
  dplyr::group_by(Treatment, Planted) |>
  dplyr::summarise(abundancias = list(n_total), .groups = "drop") |>
  dplyr::mutate(nome_grupo = paste(Treatment, Planted, sep = "_")) %>% 
  { setNames(.$abundancias, .$nome_grupo) }
res_inext <- iNEXT::iNEXT(
  dados_list,
  q = 0,
  size=seq(0, 450, 10),
  datatype = "abundance"
)

estimativas <- res_inext$iNextEst |>
  dplyr::bind_rows() |>
  tidyr::separate(Assemblage, into = c("Treatment", "Percent", "Planted"), sep = "_")

curvas_df0 <- estimativas |> 
  dplyr::filter(Order.q==0)|> 
  dplyr::filter(!is.na(SC.LCL))|>
  dplyr::mutate(
    Percent = ifelse(Percent=="Planted", "100", Percent),
    Percent = ordered(Percent, levels = c("25", "50", "100")),
    Planted = ifelse(Planted=="Inside", "Planted", "Unplanted"),
    Treatment = ifelse(Treatment=="Full", "Planting 100%", Treatment),
    Treatment = factor(Treatment, levels = c("Nuclei", "Strip", "Planting 100%"), ordered = TRUE)
  ) 

fig_recruit_rich <- curvas_df0 |>
  ggplot(aes(x = m, y = qD, color = Treatment, linetype = Planted)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL, fill = Treatment), alpha = 0.2, colour = NA) +
   geom_point(
    data = dplyr::filter(curvas_df0, Method == "Observed"),
    size = 2.5
  ) +
  facet_grid(Percent~., 
             labeller =  as_labeller(
               c("25" = "(a) Planting 25%",
                 "50" = "(b) Planting 50%",
                 "100" = "(c) Planting 100%")
               )) +
  scale_color_manual(values=c("red", "blue", "darkgreen"))+
  scale_fill_manual(values=c("red", "blue", "darkgreen"))+
  labs(
    x = "Number of sampling units (regenerants)",
    y = "Species diversity (Hill Index, q=0)"
    ) +
  ggthemes::theme_clean()+
  scale_x_continuous(expand = c(0.001, 0), breaks = seq(0, 450, 50)) +
  scale_y_continuous(expand = c(0, 0))+
  theme(
     panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(color = "black", hjust = 1, size = 10),
    axis.text.y = element_text(color = "black", size = 9),
    axis.title.y = element_text(color = "black", size = 11),
    strip.text = element_text(color = "black", hjust = 0.5, size = 10),
    strip.placement = "outside",
    legend.text = element_text(size = 11),
    legend.title = element_blank(),
    legend.key.size = unit(5, "mm"),
    legend.box.background = element_blank(),
    legend.box.margin = margin(t = 5, r = 0, b = 0, l = 0, "mm"),
    legend.background = element_blank(),
    legend.margin = margin(0, 0, 0, 0),
    legend.position = c(0.25, 0.25),
    panel.border = element_rect(colour = "black", fill = NA),
    panel.spacing = unit(0, "lines")
  )
```


Plotting and saving

```{r, fig.height=8.26, fig.width=3.54}
fig_recruit_rich
ggsave("fig_richness_no_ruderal_small_recruits.png", plot=fig_recruit_rich, width=90, height = 210 ,unit="mm")
```


#### Table S2 - Recruitment (no ruderal)

Estimating Density of recruits ($ind.ha^{-1}$) without *Baccharis* and *Vernonanthura*

```{r}
density_recruits_n_m2 <- species_table |> 
  dplyr::filter(!scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  dplyr::mutate(
    n_small = dplyr::if_else(is.na(n_sapling), 0, n_sapling),
    n_large = dplyr::if_else(is.na(n_tree), 0, n_tree)) |>
  dplyr::group_by(Treatment, Block, Planted) |>
  dplyr::summarise(
    n_small_m2 = (sum(n_small, na.rm=T))/(144*4), 
    n_large_m2 = (sum(n_large, na.rm=T))/(144*4), 
    .groups = "drop")

dens_ha <- density_recruits_n_m2 |>
  dplyr::mutate(
    n_small_ha = n_small_m2 * 10000,
    n_large_ha = n_large_m2 * 10000
  )
dens_P_UP <- dens_ha |>
  tidyr::pivot_wider(
    names_from = Planted,
    values_from = c(n_small_ha, n_large_ha),
    names_sep = "_"
  )

prop_table <- tidyr::tibble(
  Treatment = unique(sort(species_table$Treatment)),
  prop_P = c(1, 0.25, 0.5, 0.25, 0.5),
  prop_UP = 1 - prop_P
)

result_regenerant <- dens_P_UP |>
  dplyr::left_join(prop_table, by = "Treatment") |>
  dplyr::mutate(
    n_small_total_ha = dplyr::coalesce(n_small_ha_Inside * prop_P, 0)  + dplyr::coalesce(n_small_ha_Outside * prop_UP, 0),
    n_large_total_ha = dplyr::coalesce(n_large_ha_Inside * prop_P, 0) + dplyr::coalesce(n_large_ha_Outside * prop_UP, 0)
  ) |>
  dplyr::select(Treatment,
         starts_with("n_small_ha"),
         starts_with("n_large_ha"),
         n_small_total_ha,
         n_large_total_ha
  )
```


**Smaller recruits**

* Only in *planted* areas (without ruderal species)

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_ha_Inside, na.rm=TRUE),1),
    min = round(min(n_small_ha_Inside, na.rm=TRUE),0),
    max = round(max(n_small_ha_Inside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```

* Only in *unplanted* areas (without ruderal species)

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_ha_Outside, na.rm=TRUE), 1),
    min = round(min(n_small_ha_Outside, na.rm=TRUE), 0),
    max = round(max(n_small_ha_Outside, na.rm=TRUE), 0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* In *total* (planted + unplanted areas)


```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_total_ha, na.rm=TRUE),1),
    min = round(min(n_small_total_ha, na.rm=TRUE),0),
    max = round(max(n_small_total_ha, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


**Larger recruits**

* Only in *planted* areas (without ruderal species)

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_ha_Inside, na.rm=TRUE),1),
    min = round(min(n_large_ha_Inside, na.rm=TRUE),0),
    max = round(max(n_large_ha_Inside, na.rm=TRUE),0)
  ) |>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* Only in *unplanted* areas

```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_ha_Outside, na.rm=TRUE),1),
    min = round(min(n_large_ha_Outside, na.rm=TRUE),0),
    max = round(max(n_large_ha_Outside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* In *total* (planted + unplanted areas)


```{r}
result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_total_ha, na.rm = TRUE), 1),
    min = round(min(n_large_total_ha, na.rm = TRUE), 0),
    max = round(max(n_large_total_ha, na.rm = TRUE), 0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


#### Analysis for smaller recruits abundance

Data:

```{r}
small_df <- species_table |>
  dplyr::filter(!scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  dplyr::group_by(Treatment, Block, Plot, Planted)|>
  dplyr::summarise(n = sum(n_sapling), .groups="drop")

small_df |>
  ggplot(aes(x=Planted, y=n, color=Block))+
  geom_point()+facet_wrap(~Treatment)+theme_bw()
```


Models:


```{r}
modelo_reg1 <- glmmTMB::glmmTMB(n ~ Treatment*Planted + (1 | Block),
                   # family = poisson(),
                   family = glmmTMB::nbinom2(),
                   data = small_df)

modelo_reg2 <-  glmmTMB::glmmTMB(n ~ Treatment + (1 | Block),
                   # family = poisson(),
                   family = glmmTMB::nbinom2(),
                   data = small_df)
modelo_reg3 <-  glmmTMB::glmmTMB(n ~ Planted + (1 | Block),
                   # family = poisson(),
                   family = glmmTMB::nbinom2(),
                   data = small_df)
modelo_reg_null <-  glmmTMB::glmmTMB(n ~ 0 + (1 | Block),
                   # family = poisson(), # Poisson
                   family = glmmTMB::nbinom2(), # NB
                   data = small_df)

# NBinom 1270.77 (null) |	1226.20 (Treatment*Planted) | 1250.26	(only Treament) | 1227.00	(only Planted)
# Poisson  4032.177	|	3373.854		|	3813.769		|	3759.763

AIC(modelo_reg_null, modelo_reg1, modelo_reg2, modelo_reg3)
```

`non-positive-definite Hessian matrix`  indicates that there are problems in estimating the model parameters. This may be related to redundancies in the random effects, perfect separation, few data for some combinations of factors, or problems in choosing the distribution. Therefore, let's check the singularity:



```{r}
performance::check_singularity(modelo_reg1)
performance::check_model(modelo_reg1)
```

Exploring residuals

```{r, fig.width=10, fig.height=10}
par(mfrow=c(2,2))
DHARMa::plotResiduals(modelo_reg1)
DHARMa::plotQQunif(modelo_reg1)
DHARMa::plotResiduals(modelo_reg3)
DHARMa::plotQQunif(modelo_reg3)
```


```{r}
car::Anova(modelo_reg1)
```


Is there any difference between treatments considering only inside or outside?

```{r}
emmeans::emmeans(modelo_reg1, ~ Treatment|Planted) |> 
  multcomp::cld(adjust="bonferroni")
```

**Answer:** No

Is there any difference between inside/outside considering treatments?

```{r}
emmeans::emmeans(modelo_reg1, ~ Planted|Treatment) |> 
    multcomp::cld(adjust="bonferroni")
```

**Answer:** Yes.

```{r}
sjPlot::tab_model(modelo_reg1)
broom.mixed::tidy(modelo_reg1) |>
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3))) |> dplyr::select(-c(group,component))
```


#### Analysis for larger recruits abundance

Data:

```{r}
large_regenerants_2024 <- species_table |>
  dplyr::filter(!scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  dplyr::group_by(Treatment, Block, Plot, Planted)|>
  dplyr::summarise(n = sum(n_tree), .groups="drop")
```

Plotting

```{r}
large_regenerants_2024 |>
  ggplot(aes(x=Planted, y=n, color=Block))+
  geom_point()+facet_wrap(~Treatment)+theme_bw()
```


Models

```{r}
modelo_reg1 <- glmmTMB::glmmTMB(n ~ Treatment*Planted + (1 | Block),
                   ziformula = ~1,
                    # family = poisson(),
                     family = glmmTMB::nbinom2(),
                    # family = glmmTMB::truncated_nbinom2(),
                   data = large_regenerants_2024)
modelo_reg2 <-  glmmTMB::glmmTMB(n ~ Treatment + (1 | Block),
                   ziformula = ~1,
                   #  family = poisson(),
                    family = glmmTMB::nbinom2(),
                   # family = glmmTMB::truncated_nbinom2(),
                   data = large_regenerants_2024)
modelo_reg3 <-  glmmTMB::glmmTMB(n ~ Planted + (1 | Block),
                   ziformula = ~1,
                   # family = poisson(),
                    family = glmmTMB::nbinom2(),
                   #  family = glmmTMB::truncated_nbinom2(),
                   data = large_regenerants_2024)
modelo_reg_null <-  glmmTMB::glmmTMB(n ~ 0 + (1 | Block),
                   ziformula = ~1,
                    # family = poisson(), # ZIP
                     family = glmmTMB::nbinom2(), # ZINB
                    # family = glmmTMB::truncated_nbinom2(), # hurdle
                   data = large_regenerants_2024)
# Model (null) | (treat*planted) | (treat) | (planted)
# ZINB 855.21		|	843.24		 |	840.70	|	838.42

AIC(modelo_reg_null, modelo_reg1, modelo_reg2, modelo_reg3)
performance::check_model(modelo_reg1)
```


Exploring residuals

```{r}
par(mfrow=c(2,2))
DHARMa::plotResiduals(modelo_reg1)
DHARMa::plotQQunif(modelo_reg1)
DHARMa::plotResiduals(modelo_reg3)
DHARMa::plotQQunif(modelo_reg3)
```


```{r}
car::Anova(modelo_reg1)
```

Is there any difference between treatments considering inside/outside?

```{r}
emmeans::emmeans(modelo_reg1, ~ Treatment|Planted) |> 
  multcomp::cld(adjust = "bonferroni")
```

**Answer:** No.

Is there any difference between inside/outside considering treatments?

```{r}
emmeans::emmeans(modelo_reg1, ~ Planted|Treatment) |> 
  multcomp::cld(adjust = "bonferroni")
```

**Answer:** No.

#### Table S3

```{r}
sjPlot::tab_model(modelo_reg1)

broom.mixed::tidy(modelo_reg1) |>
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3))) |>
  knitr::kable()
```

#### Propotion of smaller recruits from planted species


* Without ruderal species

Getting proportions of planted/unplanted species

```{r}
prop_regenerant_part <- species_table |>
  dplyr::filter(!scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  dplyr::mutate(
    planted_tree = ifelse(`Planting group`=="NA", "No", "Yes"))|>
  dplyr::filter(n_sapling>0)|>
  dplyr::group_by(Treatment, Planted, Block, Plot) |>
  dplyr::summarise(
    n_species = dplyr::n(),
    n_ind = sum(n_sapling),
    n_planted_ind = sum(ifelse(planted_tree == "Yes", n_sapling, 0), na.rm = TRUE),
    n_planted_ind = ifelse(is.na(n_planted_ind), 0, n_planted_ind),
    n_planted_spp = sum(planted_tree == "Yes"), 
    n_planted_spp = ifelse(is.na(n_planted_spp), 0, n_planted_spp),
    .groups = "drop") |>
  dplyr::mutate(
    prop_planted_ind = n_planted_ind / n_ind,
    prop_planted_spp = n_planted_spp / n_species
  )

prop_regenerant_part |>
  dplyr::group_by(Treatment, Planted)|>
  dplyr::summarise(
    prop_planted_mean = mean(prop_planted_ind, na.rm=T),
    prop_planted_min = min(prop_planted_ind, na.rm=T),
    prop_planted_max = max(prop_planted_ind, na.rm=T),
    prop_planted_spp_mean = mean(prop_planted_spp, na.rm=T),
    prop_planted_spp_min = min(prop_planted_spp, na.rm=T),
    prop_planted_spp_max = max(prop_planted_spp, na.rm=T),
    .groups = "drop"
  ) |>
  dplyr::mutate(
    prop_planted = sprintf("%.1f (%.1f - %.1f)", 
                                round(prop_planted_mean,3)*100, 
                                round(prop_planted_min,3)*100, 
                                round(prop_planted_max,3)*100),
    prop_planted_spp = sprintf("%.1f (%.1f - %.1f)", 
                                    round(prop_planted_spp_mean,3)*100, 
                                    round(prop_planted_spp_min,3)*100, 
                                    round(prop_planted_spp_max,3)*100)
    ) |>
  dplyr::select(Treatment,Planted, prop_planted, prop_planted_spp) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = c(prop_planted, prop_planted_spp)
    ) # |> writexl::write_xlsx("resulta_prop_recruit.xlsx")
```


```{r}
prop_regenerant_part |>
  dplyr::group_by(Planted)|>
  dplyr::summarise(
    prop_planted_mean = mean(prop_planted_ind, na.rm=T),
    prop_planted_se = (sd(prop_planted_ind, na.rm=T))/sqrt(dplyr::n()),
    prop_planted_spp_mean = mean(prop_planted_spp, na.rm=T),
    prop_planted_spp_se = (sd(prop_planted_spp, na.rm=T))/sqrt(dplyr::n()),
    .groups = "drop"
  )
```


Statistical analysis for proportion of individuals:

```{r}
mod_binomial_part <-lme4::glmer(
  cbind(n_planted_ind, n_ind - n_planted_ind) ~ Treatment*Planted + (1 | Block),
  family = binomial(link = "logit"),
  data = prop_regenerant_part)

performance::check_overdispersion(mod_binomial_part) # yes
```

It should be Beta

```{r}
mod_beta_part <-glmmTMB::glmmTMB(
  cbind(n_planted_ind, n_ind - n_planted_ind) ~ Treatment*Planted + (1 | Block),
  family = glmmTMB::betabinomial(link = "logit"),
  data = prop_regenerant_part)
performance::check_model(mod_beta_part)
DHARMa::plotResiduals(mod_beta_part)
```

Pairwise:

```{r}
emmeans::emmeans(mod_beta_part, pairwise ~ Treatment | Planted) |> multcomp::cld(adjust="sidak") # no differences
emmeans::emmeans(mod_beta_part, pairwise ~  Planted | Treatment) |> multcomp::cld(adjust="sidak") # All different
```

Statistical analysis for proportion of individuals:

```{r}
mod_binomial_prop <-lme4::glmer(
  cbind(n_planted_spp, n_species - n_planted_spp) ~ Treatment*Planted + (1 | Block),
  family = binomial(link = "logit"),
  data = prop_regenerant_part)

performance::check_overdispersion(mod_binomial_prop) # underdispersion
```

It should be Beta

```{r}
mod_beta_prop <-glmmTMB::glmmTMB(
  cbind(n_planted_spp, n_species - n_planted_spp) ~ Treatment*Planted + (1 | Block),
  family = glmmTMB::betabinomial(link = "logit"),
  data = prop_regenerant_part)
performance::check_model(mod_beta_prop)
DHARMa::plotResiduals(mod_beta_prop)
```

Pairwise:

```{r}
emmeans::emmeans(mod_beta_prop, pairwise ~ Treatment | Planted) |> multcomp::cld(adjust="sidak") # no differences
emmeans::emmeans(mod_beta_prop, pairwise ~  Planted | Treatment) |> multcomp::cld(adjust="sidak") # All different
```



#### Table S3

```{r}
broom.mixed::tidy(mod_beta_part) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))
sjPlot::tab_model(mod_beta_part)
```


### (iii) *Only* considering Baccharis + Vernonanthura


#### Table S2 - Only ruderal

Estimating density of recruits ($ind.ha^{-1}$) and without ruderal (*Baccharis* and *Vernonanthura*)

```{r}
density_ruderal_n_m2 <- species_table |> 
  dplyr::filter(scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  # dplyr::select(Treatment, Block, Plot, Planted)|>unique()|>   with(table(Block, Plot, by=Treatment)) # Full_Planted P2B5 & P3B1 (Inside)
  dplyr::add_row(
    scientificName = c(NA, NA),
    `Seed dispersal` = c(NA, NA),
    `Planting group` = c(NA, NA),
    Treatment = c("Full_Planted", "Full_Planted"),
    Block = c("B5", "B1"),
    Plot = c("P2", "P3"),
    Planted = c("Inside","Inside"),
    n_sapling= c(0,0),
    n_tree = c(0,0)
    ) |>
  dplyr::mutate(
    n_small = dplyr::if_else(is.na(n_sapling), 0, n_sapling),
    n_large = dplyr::if_else(is.na(n_tree), 0, n_tree)) |>
  dplyr::group_by(Treatment, Block, Planted) |>
  dplyr::summarise(
    n_small_m2 = (sum(n_small, na.rm=T))/(144*4), 
    n_large_m2 = (sum(n_large, na.rm=T))/(144*4), 
    .groups = "drop")

dens_ruderal_ha <- density_ruderal_n_m2 |>
  dplyr::mutate(
    n_small_ha = n_small_m2 * 10000,
    n_large_ha = n_large_m2 * 10000
  )
dens_ruderal_P_UP <- dens_ruderal_ha |>
  tidyr::pivot_wider(
    names_from = Planted,
    values_from = c(n_small_ha, n_large_ha),
    names_sep = "_"
  )

prop_table <- tidyr::tibble(
  Treatment = unique(sort(species_table$Treatment)),
  prop_P = c(1, 0.25, 0.5, 0.25, 0.5),
  prop_UP = 1 - prop_P
)

result_ruderal <- dens_ruderal_P_UP |>
  dplyr::left_join(prop_table, by = "Treatment") |>
  dplyr::mutate(
    n_small_total_ha = dplyr::coalesce(n_small_ha_Inside * prop_P, 0)  + dplyr::coalesce(n_small_ha_Outside * prop_UP, 0),
    n_large_total_ha = dplyr::coalesce(n_large_ha_Inside * prop_P, 0) + dplyr::coalesce(n_large_ha_Outside * prop_UP, 0)
  ) |>
  dplyr::select(Treatment,
         starts_with("n_small_ha"),
         starts_with("n_large_ha"),
         n_small_total_ha,
         n_large_total_ha
  )
```


**Smaller recruits**

* Only in *planted* areas

```{r}
result_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_ha_Inside, na.rm=TRUE),1),
    min = round(min(n_small_ha_Inside, na.rm=TRUE),0),
    max = round(max(n_small_ha_Inside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```

* Only in *unplanted* areas

```{r}
result_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_ha_Outside, na.rm=TRUE), 1),
    min = round(min(n_small_ha_Outside, na.rm=TRUE), 0),
    max = round(max(n_small_ha_Outside, na.rm=TRUE), 0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* In *total* (planted + unplanted areas)


```{r}
result_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_small_total_ha, na.rm=TRUE),1),
    min = round(min(n_small_total_ha, na.rm=TRUE),0),
    max = round(max(n_small_total_ha, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


**Larger recruits**

All treatments and inside/outside areas showed similar values

* Only in *planted* areas

```{r}
result_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_ha_Inside, na.rm=TRUE),1),
    min = round(min(n_large_ha_Inside, na.rm=TRUE),0),
    max = round(max(n_large_ha_Inside, na.rm=TRUE),0)
  ) |>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* Only in *unplanted* areas

```{r}
result_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_ha_Outside, na.rm=TRUE),1),
    min = round(min(n_large_ha_Outside, na.rm=TRUE),0),
    max = round(max(n_large_ha_Outside, na.rm=TRUE),0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


* In *total* (planted + unplanted areas)


```{r}
result_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean = round(mean(n_large_total_ha, na.rm = TRUE), 1),
    min = round(min(n_large_total_ha, na.rm = TRUE), 0),
    max = round(max(n_large_total_ha, na.rm = TRUE), 0)
  )|>
  dplyr::mutate(
    larger = sprintf("%.1f (%.1f - %.1f)", 
                                mean, 
                                min, 
                                max)) |>
  dplyr::select(Treatment, larger) |>
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = larger
    )
```


#### Analysis for their abundances

```{r}
ruderal_df <- species_table |> 
  dplyr::filter(scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes"))|>
  # dplyr::select(Treatment, Block, Plot, Planted)|>unique()|>   with(table(Block, Plot, by=Treatment)) # Full_Planted P2B5 & P3B1 (Inside)
  dplyr::add_row(
    scientificName = c(NA, NA),
    `Seed dispersal` = c(NA, NA),
    `Planting group` = c(NA, NA),
    Treatment = c("Full_Planted", "Full_Planted"),
    Block = c("B5", "B1"),
    Plot = c("P2", "P3"),
    Planted = c("Inside","Inside"),
    n_sapling= c(0,0),
    n_tree = c(0,0),
    n_total= c(0,0)
    )|>
  dplyr::group_by(Treatment, Block, Plot, Planted)|>
  dplyr::summarise(n = sum(n_total), .groups="drop")
```

Plotting

```{r}
ruderal_df |>
  ggplot(aes(x=Planted, y=n, color=Block))+
  geom_point()+facet_wrap(~Treatment)+theme_bw()
```


Models

```{r}
modelo_rud1 <- glmmTMB::glmmTMB(n ~ Treatment*Planted + (1 | Block),
                   ziformula = ~1,
                    # family = poisson(),
                     family = glmmTMB::nbinom2(),
                    # family = glmmTMB::truncated_nbinom2(),
                   data = ruderal_df)
modelo_rud2 <-  glmmTMB::glmmTMB(n ~ Treatment + (1 | Block),
                   ziformula = ~1,
                   #  family = poisson(),
                    family = glmmTMB::nbinom2(),
                    # family = glmmTMB::truncated_nbinom2(),
                   data = ruderal_df)
modelo_rud3 <-  glmmTMB::glmmTMB(n ~ Planted + (1 | Block),
                   ziformula = ~1,
                   # family = poisson(),
                    family = glmmTMB::nbinom2(),
                  #   family = glmmTMB::truncated_nbinom2(),
                   data = ruderal_df)
modelo_rud_null <-  glmmTMB::glmmTMB(n ~ 0 + (1 | Block),
                    ziformula = ~1,
                    # family = poisson(), # ZIP
                     family = glmmTMB::nbinom2(), # ZINB
                    # family = glmmTMB::truncated_nbinom2(), # hurdle
                   data = ruderal_df)
# Model (null) | (treat*planted) | (treat) | (planted)
# ZIP

AIC(modelo_rud_null, modelo_rud1, modelo_rud2, modelo_rud3)
performance::check_overdispersion(modelo_rud1)
performance::check_model(modelo_rud1)
```


Exploring residuals

```{r}
par(mfrow=c(2,2))
DHARMa::plotResiduals(modelo_rud1)
DHARMa::plotQQunif(modelo_rud1)
DHARMa::plotResiduals(modelo_rud3)
DHARMa::plotQQunif(modelo_rud3)
```


```{r}
car::Anova(modelo_rud1)
```

Is there any difference between treatments considering inside/outside?

```{r}
emmeans::emmeans(modelo_rud1, ~ Treatment|Planted) |> 
  multcomp::cld(adjust = "bonferroni")
```

**Answer:** Yes  (planted) and no (only unplanted areas)

Is there any difference between inside/outside considering treatments?

```{r}
emmeans::emmeans(modelo_rud1, ~ Planted|Treatment) |> 
  multcomp::cld(adjust = "bonferroni")
```

**Answer:** No.

#### Table S3

```{r}
sjPlot::tab_model(modelo_rud1)
broom.mixed::tidy(modelo_rud1) |>
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3))) |>
  dplyr::select(-c(component, group))|>
  knitr::kable()
```


### (iv) Figure Recruitment


*Small letters*: Comparison between treatments, only inside planted areas. 

*Capital letters*: Comparison between treatments, only outside planted areas.

#### Smaller recruits

```{r}
ordem <- c("Nuclei_25", "Strip_25", "Nuclei_50", "Strip_50", "Full_Planted")

recruits_ha <- species_table |> 
  dplyr::filter(!scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes")) |>
  dplyr::mutate(
    n_small = dplyr::if_else(is.na(n_sapling), 0, n_sapling),
    n_large = dplyr::if_else(is.na(n_tree), 0, n_tree)) |>
  dplyr::group_by(Treatment, Block, Planted) |>
  dplyr::summarise(
    n_small_m2 = (sum(n_small, na.rm=T))/(144*4), 
    n_large_m2 = (sum(n_large, na.rm=T))/(144*4), 
    .groups = "drop") |>
  dplyr::mutate(
    n_small_ha = n_small_m2 * 10000,
    n_large_ha = n_large_m2 * 10000
  ) |>
  tidyr::pivot_wider(
    names_from = Planted,
    values_from = c(n_small_ha, n_large_ha),
    names_sep = "_"
  ) |>
  dplyr::select(Treatment, Block, n_small_ha_Inside:n_large_ha_Outside)

ruderal_ha <- species_table |> 
  dplyr::filter(scientificName %in% c("Baccharis dracunculifolia", "Vernonanthura polyanthes")) |>
  dplyr::mutate(
    n_small = dplyr::if_else(is.na(n_sapling), 0, n_sapling),
    n_large = dplyr::if_else(is.na(n_tree), 0, n_tree)) |>
  dplyr::group_by(Treatment, Block, Planted) |>
  dplyr::summarise(
    n_small_m2 = (sum(n_small, na.rm=T))/(144*4), 
    n_large_m2 = (sum(n_large, na.rm=T))/(144*4), 
    .groups = "drop") |>
  dplyr::mutate(
    n_small_ha = n_small_m2 * 10000,
    n_large_ha = n_large_m2 * 10000
  ) |>
  tidyr::pivot_wider(
    names_from = Planted,
    values_from = c(n_small_ha, n_large_ha),
    names_sep = "_"
  ) |>
  dplyr::select(Treatment, Block, n_small_ha_Inside:n_large_ha_Outside)


prop_table <- tidyr::tibble(
  Treatment = unique(sort(species_table$Treatment)),
  prop_P = c(1, 0.25, 0.5, 0.25, 0.5),
  prop_UP = 1 - prop_P
)

data_fig_recruits <- recruits_ha |>
  dplyr::left_join(prop_table, by = "Treatment") |>
  dplyr::mutate(
    n_small_total_ha = dplyr::coalesce(n_small_ha_Inside * prop_P, 0)  + dplyr::coalesce(n_small_ha_Outside * prop_UP, 0),
    n_large_total_ha = dplyr::coalesce(n_large_ha_Inside * prop_P, 0) + dplyr::coalesce(n_large_ha_Outside * prop_UP, 0)
  ) |>
  dplyr::select(Treatment,
         starts_with("n_small_ha"),
         starts_with("n_large_ha"),
         n_small_total_ha,
         n_large_total_ha
  )
data_fig_ruderal <- ruderal_ha |>
  dplyr::left_join(prop_table, by = "Treatment") |>
  dplyr::mutate(
    n_small_total_ha = dplyr::coalesce(n_small_ha_Inside * prop_P, 0)  + dplyr::coalesce(n_small_ha_Outside * prop_UP, 0),
    n_large_total_ha = dplyr::coalesce(n_large_ha_Inside * prop_P, 0) + dplyr::coalesce(n_large_ha_Outside * prop_UP, 0)
  ) |>
  dplyr::select(Treatment,
         starts_with("n_small_ha"),
         starts_with("n_large_ha"),
         n_small_total_ha,
         n_large_total_ha
  )
```

Small regenerants

```{r}
data_fig_small_1 <- data_fig_recruits |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean_inside = round(mean(n_small_ha_Inside, na.rm=TRUE), 1),
    se_inside = round((sd(n_small_ha_Inside, na.rm=TRUE))/sqrt(dplyr::n()), 1),
    mean_outside = round(mean(n_small_ha_Outside, na.rm=TRUE), 1),
    se_outside = round((sd(n_small_ha_Outside, na.rm=TRUE))/sqrt(dplyr::n()), 1)
  ) |>
   tidyr::pivot_longer(cols = -Treatment, names_to = c(".value", "side"), names_sep = "_") |> 
  dplyr::filter(!is.na(se)) |>
  dplyr::mutate(class="regenerant")

data_fig_small_2 <- data_fig_ruderal |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean_inside = round(mean(n_small_ha_Inside, na.rm=TRUE), 1),
    se_inside = round((sd(n_small_ha_Inside, na.rm=TRUE))/sqrt(dplyr::n()), 1),
    mean_outside = round(mean(n_small_ha_Outside, na.rm=TRUE), 1),
    se_outside = round((sd(n_small_ha_Outside, na.rm=TRUE))/sqrt(dplyr::n()), 1)
  ) |>
   tidyr::pivot_longer(cols = -Treatment, names_to = c(".value", "side"), names_sep = "_") |> 
  dplyr::filter(!is.na(se)) |>
  dplyr::mutate(class="ruderal")
data_fig_small <- dplyr::bind_rows(data_fig_small_1,data_fig_small_2)
```


New Figure 

```{r, fig.width=3.54, fig.height=2.36}
ordem_x <- c(
  "Nuclei_25_inside", "Nuclei_25_outside",
  "Strip_25_inside",  "Strip_25_outside",
  "Nuclei_50_inside", "Nuclei_50_outside",
  "Strip_50_inside",  "Strip_50_outside",
  "Full_Planted_inside"
)

data_fig_small_top2 <- data_fig_small |>
  group_by(Treatment, side) |>
  arrange(desc(class)) |>
  mutate(cum_mean = cumsum(mean)) |>
  ungroup() |>
  mutate(Treat_side = interaction(Treatment, side, sep = "_"),
         Treat_side = factor(Treat_side, levels = ordem_x))

letras <- data.frame(
  Treat_side = levels(data_fig_small_top2$Treat_side),
  label = c("Ab","Aa",
            "Ab","Aa",
            "Aa","Aa",
            "Ab","Aa",
            "A"),  
  y = c(5000, 4500, 
        5000, 4000, 
        6500, 4000, 
        6500, 4500, 
        3500)            
)


fig_small<-ggplot(data_fig_small_top2, 
       aes(x = Treat_side, y = mean, fill = side, pattern = class)) +
  geom_col_pattern(
    position = "stack",
    color = "black",
    pattern_fill = "#92D050", pattern_alpha = 0.5,
    pattern_angle = 45, pattern_density = 0.1,
    pattern_spacing = 0.1
  ) +
  scale_pattern_manual(
    values = c("regenerant" = "none", "ruderal" = "stripe"),
    guide = "none") +
  scale_fill_manual(labels = c("Planted", "Unplanted"), 
                    values = c("#92D050", "white")) +
  geom_errorbar(
    data = data_fig_small_top2 |> group_by(Treatment, side) |> slice_tail(n = 1),
    aes(ymin = cum_mean - se, ymax = cum_mean + se, x = Treat_side),
    width = .2,
    inherit.aes = FALSE
  ) +
  labs(fill = "", 
       y =  expression("Recruits (n.ha"^{-1}~")"),
       x = "") +
  geom_text(data = letras, 
          aes(x = Treat_side, y = y, label = label), 
          inherit.aes = FALSE,  
          size = 3.5, vjust = -0.5) +
  scale_x_discrete(labels = function(x) gsub("_", "\n", x)) +
  scale_y_continuous(expand =c(0,0), limits = c(0,7500), breaks = seq(0,  7000, by=1500))+
  theme_classic() +
  theme(
    axis.text.x = element_blank(), #element_text(color="black", hjust = 0.5, size=9),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=11),
    legend.position = c(0.18, 0.95),
    legend.text = element_text(size = 10),
    legend.key.size = unit(3, "mm"),
    legend.spacing = unit(0, "mm"),
    legend.background = element_blank(),
    legend.title = element_text(size = 8))
fig_small
# ggsave("fig_small_recruits.png", plot=fig_small, width=90, height = 90 ,unit="mm")

```




Without overabundant species


```{r, fig.width=3.54, fig.height=2.36}
data_fig_recruits |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean_inside = round(mean(n_small_ha_Inside, na.rm=TRUE), 1),
    se_inside = round((sd(n_small_ha_Inside, na.rm=TRUE))/sqrt(dplyr::n()), 1),
    mean_outside = round(mean(n_small_ha_Outside, na.rm=TRUE), 1),
    se_outside = round((sd(n_small_ha_Outside, na.rm=TRUE))/sqrt(dplyr::n()), 1)
  ) |>
   tidyr::pivot_longer(cols = -Treatment, names_to = c(".value", "side"), names_sep = "_") |> 
  dplyr::filter(!is.na(se)) |>
  dplyr::mutate(
    tratamento = factor(Treatment, ordered = TRUE, levels = c("Nuclei_25", "Strip_25", "Nuclei_50", "Strip_50","Full_Planted")),
    tratamento = forcats::fct_recode(tratamento, 
                                     "Nuclei\n25%" = "Nuclei_25", "Strips\n25%" = "Strip_25", 
                                     "Nuclei\n50%" = "Nuclei_50","Strips\n50%" = "Strip_50","Planting\n100%" = "Full_Planted")
  )|>
  ggplot(aes(x = tratamento, y = mean, fill = side)) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(labels = c('Planted', 'Unplanted'), 
                    values = c("#92D050", "white")) +
  # geom_text(data = letras, aes(x = tratamento, y = y, label = label), size=3.5, vjust = -0.5) +
  scale_y_continuous(expand =c(0,0), limits = c(0,1700), breaks = seq(0,  1700, by=500))+
  labs(fill = "", 
       y =  expression("Recruits (n.ha"^{-1}~")"),
       x = "") +
  theme_classic()+
  theme(
    axis.text.x = element_text(color="black", hjust = 0.5, size=10),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=11),
    legend.position = c(0.16, 0.98),
    plot.margin = margin(t=5, l=2, r=2, 0, "mm"),
    legend.text = element_text(size = 10, margin = margin(t=0,0,0,l=1, "mm")),
    legend.key.size = unit(3, "mm"),
    legend.spacing = unit(0, "mm"),
    legend.background = element_blank(),
    legend.title = element_text(size = 8))
```

#### Larger recruits


```{r}
data_fig_large <- result_regenerant |>
  dplyr::group_by(Treatment)|>
  dplyr::summarise(
    mean_inside = round(mean(n_large_ha_Inside, na.rm=TRUE), 1),
    se_inside = round((sd(n_large_ha_Inside, na.rm=TRUE))/sqrt(dplyr::n()), 1),
    mean_outside = round(mean(n_large_ha_Outside, na.rm=TRUE), 1),
    se_outside = round((sd(n_large_ha_Outside, na.rm=TRUE))/sqrt(dplyr::n()), 1)
  ) |>
   tidyr::pivot_longer(cols = -Treatment, names_to = c(".value", "side"), names_sep = "_") |> 
  dplyr::mutate(
    Treatment = ordered(Treatment,levels = ordem),
    tratamento = forcats::fct_recode(Treatment, 
                                     "Nuclei 25%" = "Nuclei_25", "Strips 25%" = "Strip_25", 
                                     "Nuclei 50%" = "Nuclei_50", "Strips 50%" = "Strip_50","Planting 100%" = "Full_Planted"),
    Treat_side = interaction(Treatment, side, sep = "_"),
    Treat_side = factor(Treat_side, ordered = TRUE, levels = ordem_x,
                         labels = c("Nuclei\n  25%", " " ,
                                    "Strips\n  25%", "  ", 
                                    "Nuclei\n  50%", "   ",
                                    "Strips\n  50%", "    ",
                                    "Planting\n100%"))
  )|>
  dplyr::filter(!is.na(se))
```


Inside and outside planted areas are similar

```{r, fig.width=3.54, fig.height=2.36}
letras <- data.frame(
  tratamento = rep(levels(as.factor(data_fig_large$tratamento)), each=2),
  side = levels(as.factor(data_fig_large$side)),
  label = c("A      ","      a",
            "A      ","      a",
            "A      ","      a",
            "A      ","      a",
            "A",""),  
  y = c(300, 470, 
        200, 340, 
        200, 200, 
        300, 470, 
        320, 400)            
)

fig_large <- data_fig_large |>
  ggplot(aes(x = tratamento, y = mean, fill = side)) +
  geom_bar(
    position = position_dodge2(width = 1, padding = .1,preserve = "single"), 
    stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(labels = c('Planted', 'Unplanted'), values = c("#92D050", "white")) +
  geom_text(data = letras, aes(x = tratamento, y = y, label = label), size=3.5, vjust = -0.5) +
  scale_y_continuous(expand =c(0,0), limits = c(0,550), breaks = seq(0, 500, by=100))+
  labs(fill = "", 
       y =  expression("Recruits (n.ha"^{-1}*")"),
       x = "") +
  theme_classic()+
  theme(
    axis.text.x = element_text(color="black", hjust = 0.5, size=10),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=11),
    plot.margin = margin(t=5, l=2, r=2,0, "mm"),
    legend.position = "none", # c(0.90, 0.95),
    legend.text = element_text(size = 9, margin = margin(0,0,0,l=1, "mm")),
    legend.key.size = unit(3, "mm"),
    legend.spacing = unit(0, "mm"),
    legend.background = element_blank(),
    legend.title = element_text(size = 8))
fig_large
```

Another way


```{r}
letras <- data.frame(
  Treat_side = levels(data_fig_large$Treat_side),
  label = c("Aa","Aa",
            "Aa","Aa",
            "Aa","Aa",
            "Aa","Aa",
            "Aa"),  
  y = c(300, 470, 
        200, 340, 
        200, 200, 
        300, 470, 
        320) 
)
data_fig_large <- data_fig_large |>
  dplyr::mutate(hjust_value = ifelse(Treat_side == last(Treat_side), 0.5, 0))

fig_large<-ggplot(data_fig_large, 
       aes(x = Treat_side, y = mean, fill = side)) +
  geom_bar(
    stat = "identity",
    position = "stack",
    color = "black") +
  scale_fill_manual(labels = c("Planted", "Unplanted"), 
                    values = c("#92D050", "white")) +
  geom_errorbar(
    aes(ymin = mean - se, ymax = mean + se, x = Treat_side),
    width = .2
  ) +
  labs(fill = "", 
       y =  expression("Recruits (n.ha"^{-1}*")"),
       x = "") +
  geom_text(data = letras, 
          aes(x = Treat_side, y = y, label = label), 
          inherit.aes = FALSE,  
          size = 3.5, vjust = -0.5) +
  scale_y_continuous(expand =c(0,0), limits = c(0,550), breaks = seq(0, 500, by=100))+
  theme_classic() +
  theme(
    axis.text.x = element_text(color="black", hjust = data_fig_large$hjust_value, size=9),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=11),
    legend.position = "none",# c(0.18, 0.95),
    legend.text = element_text(size = 10),
    legend.key.size = unit(3, "mm"),
    legend.spacing = unit(0, "mm"),
    legend.background = element_blank(),
    legend.title = element_text(size = 8))
fig_large
```


#### Altogether:


```{r, fig.width=3.54, fig.height=4}
fig_recruits <- cowplot::plot_grid(fig_small + theme(axis.text.x=element_blank()), 
                                   fig_large, 
                                   ncol = 1,
                                   labels = c("(a)", "(b)"), label_size = 10, label_x = 0.01, label_y = c(1,1.1)
                                   )
fig_recruits
ggsave("fig_recruits.png", plot=fig_recruits, width=90, height = 100 ,unit="mm")
```

### (vi) Species list table

Only recruits (not including planted individuals)

```{r}
table_recruits <- readxl::read_xlsx("Itatinga_Nuc_recruitment_SpeciesList.xlsx") 
table_recruits |> knitr::kable(format = "html")
```

!
Altogether

```{r}
sampled_species <-readxl::read_xlsx("itatinga_sampled_species.xlsx")
sampled_species |> 
  dplyr::select(-`Seed dispersal`) |>
  knitr::kable(format = "html")

```



## D) Total AGB

### (i)  Organizing data

Estimation in Mg.ha-1

576 = 12m x 12m x 4 plots

```{r}
AGB_data0 <- trees_clean |>
  dplyr::group_by(ano, tratamento, bloco, plantio)|>
  dplyr::summarise(AGB_sum = sum(AGB_ferez, na.rm=T)/1000, .groups = "drop") |> # writexl::write_xlsx("AGB_plot.xlsx")
  dplyr::mutate(
    AGB_Mgha = dplyr::case_when(
      tratamento == "100" ~ (AGB_sum / 576) * 10000,
      tratamento %in% c("F50", "N50") & plantio == "CP" ~ (AGB_sum / 576) * 5000,
      tratamento %in% c("F50", "N50") & plantio == "SP" ~ (AGB_sum / 576) * 5000,
      tratamento %in% c("F25", "N25") & plantio == "CP" ~ (AGB_sum / 576) * 2500,
      tratamento %in% c("F25", "N25") & plantio == "SP" ~ (AGB_sum / 576) * 7500),
    Tratamento = ordered(tratamento, levels = ordem,
                         labels = c("Nuclei 25%", "Strips 25%", "Nuclei 50%", "Strips 50%", "Planting 100%"))) 
AGB_data <- AGB_data0 |> 
  dplyr::group_by(ano, tratamento, bloco)|>
  dplyr::summarise(AGB_Mgha = sum(AGB_Mgha), .groups = "drop") |>
  dplyr::mutate(
    Ano = ano-2021,
    ANO = factor(ano),
    scaled_AGB = scale(AGB_Mgha))
```



### (ii) Analysing Total aboveground biomass per hectare

Comparing models

```{r}
AGB_model0 <- lme4::lmer(scaled_AGB ~ 0 + (1|bloco), data = AGB_data)
AGB_model1 <- lme4::lmer(scaled_AGB ~ ANO + (1|bloco), data = AGB_data)
AGB_model2 <- lme4::lmer(scaled_AGB ~ ANO + bloco + (1|bloco), data = AGB_data) 
AGB_model3 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + bloco + (1|bloco), data = AGB_data)   # consider rescaling
AGB_model4 <- lme4::lmer(scaled_AGB ~ tratamento + ANO + bloco + (1|bloco), data = AGB_data) # isSingular
AGB_model5 <- lme4::lmer(scaled_AGB ~ tratamento + ANO + (1|bloco), data = AGB_data)         # best model 
AGB_model6 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + (1|bloco), data = AGB_data) 
AGB_model7 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + (1+Ano|bloco), data = AGB_data) # isSingular
AIC(AGB_model0, AGB_model1, AGB_model2, AGB_model3, AGB_model4, AGB_model5,AGB_model6, AGB_model7 )
```

Exploring residuals

```{r}
par(mfrow=c(1,2))
DHARMa::plotResiduals(AGB_model5)
DHARMa::plotQQunif(AGB_model5)
```

One outlier

Marginal $R^2$ / Conditional $R^2$

```{r}
MuMIn::r.squaredGLMM(AGB_model5) # without interaction 
0.696/ 0.837
MuMIn::r.squaredGLMM(AGB_model6) # with interaction
0.702/ 0.842
```

0.702/ 0.842 - variance explained by fixed effects and by the entire model (around `r0.702/ 0.842` % is explained by fixed effects)

```{r}
car::Anova(AGB_model6)
```

interaction is no significant at all ($p-value \sim 0.33$)

```{r}
car::Anova(AGB_model5)
```

Summary

```{r}
sjPlot::tab_model(AGB_model5)
broom.mixed::tidy(AGB_model5) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))
```


Assessing comparisons:

```{r}
emmeans::emmeans(AGB_model6, pairwise ~ tratamento | ANO) |> multcomp::cld()
```


```{r}
AGB_model6a <- lme4::lmer(scaled_AGB ~ tratamento*Ano + (1|bloco), data = AGB_data)
AIC(AGB_model6a, AGB_model6)
emmeans::emtrends(AGB_model6a, pairwise ~ tratamento, var = "Ano", poly.trend = TRUE) |> multcomp::cld()
```


### (iii) AGB only inside

Preparing data: 

Comparison only inside plots over the years


```{r}
ordem <-c("N25", "F25", "N50", "F50", "100")
AGB_inside0 <- trees_clean |>
  dplyr::group_by(ano, tratamento, bloco, parcela, plantio)|>
  dplyr::summarise(
    AGB_sum = sum(AGB_ferez, na.rm=T),
    .groups = "drop") |>
  dplyr::mutate(
    tratamento = ordered(tratamento, levels = ordem),
    Parcela = paste(tratamento, bloco, parcela, sep="_"),
    Ano = ano-2021) |>
  dplyr::filter(plantio == "CP")
```

View

```{r}
AGB_inside0 |>
  ggplot(aes(x = factor(ano), y = log(AGB_sum),  group = Parcela, colour = parcela)) +
  geom_point() +
  geom_line()+facet_grid(bloco~tratamento)+
  theme_minimal()
```

Plots with decreasing :

```{r}
deltas <- AGB_inside0 |>
  dplyr::select(ano, Parcela, AGB_sum)|>
  tidyr::pivot_wider(names_from = ano, names_prefix = "ano_", values_from = AGB_sum)|>
  dplyr::mutate(delta_AGB = (ano_2024/ano_2022))|>
  dplyr::arrange(delta_AGB) 
deltas |> head(10)
deltas |> tail(10)
```


How much % is planted or recruit in AGB?

```{r}
trees_clean |>
  dplyr::filter(plantio == "CP") |>
  #dplyr::filter(ano == 2024) |>
  dplyr::group_by(ano, tratamento, bloco)|>
  dplyr::summarise(
    AGB_sum = sum(AGB_ferez, na.rm=T)/1000,
    AGB_planted = sum(AGB_ferez[RP == "planted"], na.rm = TRUE)/1000,
    prop_AGB_planted = (AGB_planted / AGB_sum)*100,
    .groups = "drop") |>  #dplyr::group_by(tratamento,plantio)|>
  dplyr::summarise(mean(prop_AGB_planted),
                   sd(prop_AGB_planted)/sqrt(dplyr::n()))
```


Should I treat them with a random factor `(1|bloco)`?

```{r}
AGB_inside <- trees_clean |>
  dplyr::filter(plantio == "CP") |>
  #dplyr::filter(ano == 2024) |>
  dplyr::group_by(ano, tratamento, bloco)|>
  dplyr::summarise(AGB_sum = sum(AGB_ferez, na.rm=T)/1000, .groups = "drop") |>
  dplyr::mutate(
    Tratamento = ordered(tratamento, levels = ordem),
    Ano = ano-2021,
    ANO = ordered(ano),
    scaled_AGB = scale(AGB_sum)) 
```


Comparing models

```{r}
AGB_inside_m0 <- lme4::lmer(scaled_AGB ~ 0 + (1|bloco), data = AGB_inside)
AGB_inside_m1 <- lme4::lmer(scaled_AGB ~ ANO + (1|bloco), data = AGB_inside)
AGB_inside_m2 <- lme4::lmer(scaled_AGB ~ ANO + bloco + (1|bloco), data = AGB_inside)   # best model 
AGB_inside_m3 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + bloco + (1|bloco), data = AGB_inside)   
AGB_inside_m4 <- lme4::lmer(scaled_AGB ~ tratamento + ANO + bloco + (1|bloco), data = AGB_inside) 
AGB_inside_m5 <- lme4::lmer(scaled_AGB ~ tratamento + ANO + (1|bloco), data = AGB_inside)         
AGB_inside_m6 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + (1|bloco), data = AGB_inside) 
AGB_inside_m7 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + (1+Ano|bloco), data = AGB_inside) # isSingular
AIC(AGB_inside_m0, AGB_inside_m1, AGB_inside_m2, AGB_inside_m3, AGB_inside_m4,AGB_inside_m5, AGB_inside_m6, AGB_inside_m7)
```

Exploring residuals

```{r}
par(mfrow=c(1,2))
DHARMa::plotResiduals(AGB_inside_m6)
DHARMa::plotQQunif(AGB_inside_m6)
```

Marginal $R^2$ / Conditional $R^2$

```{r}
MuMIn::r.squaredGLMM(AGB_inside_m6)
0.396/  0.6996
```

0.396/  0.6996 variance explained by fixed effects and by the entire model (around `r 0.396/  0.6996` % is explained by fixed effects)

```{r}
car::Anova(AGB_inside_m6)
```

interaction is no significant at all ($p-value \sim 0.85$)

```{r}
sjPlot::tab_model(AGB_inside_m5)
broom.mixed::tidy(AGB_inside_m5) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))
```

Assessing comparisons:

```{r}
emmeans::emmeans(AGB_inside_m6, pairwise ~ tratamento |ANO) |> multcomp::cld()
```

```{r}
AGB_inside_m6a <- lme4::lmer(scaled_AGB ~ tratamento*Ano + (1|bloco), data = AGB_inside) 
AIC(AGB_inside_m6a, AGB_inside_m6)
emmeans::emtrends(AGB_inside_m6a, pairwise ~ tratamento, var = "Ano", poly.trend = TRUE) |> multcomp::cld()
```


### (iv) AGB only outside (unplanted areas)

Preparing data: 

Comparison only outside plots over the years


```{r}
AGB_outside0 <- trees_clean |>
  dplyr::group_by(ano, tratamento, bloco, parcela, plantio)|>
  dplyr::summarise(
    AGB_sum = sum(AGB_ferez, na.rm=T),
    .groups = "drop") |>
  dplyr::mutate(
    tratamento = ordered(tratamento, levels = ordem),
    Parcela = paste(tratamento, bloco, parcela, sep="_"),
    Ano = ano-2021) |>
  dplyr::filter(plantio == "SP")
```

View

```{r}
AGB_outside0 |>
  ggplot(aes(x = factor(ano), y = log(AGB_sum),  group = Parcela, colour = parcela)) +
  geom_point() +
  geom_line()+facet_grid(bloco~tratamento)+
  theme_minimal()
```

**it is a mess**



Tratar os valores como `(1|bloco)`?

```{r}
AGB_outside <- trees_clean |>
  dplyr::filter(plantio == "SP") |>
  #dplyr::filter(ano == 2024) |>
  dplyr::group_by(ano, tratamento, bloco)|>
  dplyr::summarise(AGB_sum = sum(AGB_ferez, na.rm=T)/1000, .groups = "drop") |>
  dplyr::mutate(
    Tratamento = ordered(tratamento, levels = ordem),
    Ano = ano-2021,
    ANO = ordered(ano),
    scaled_AGB = scale(AGB_sum)) 
```


Comparing models

```{r}
AGB_outside_m0 <- lme4::lmer(scaled_AGB ~ 0 + (1|bloco), data = AGB_outside) # best model
AGB_outside_m1 <- lme4::lmer(scaled_AGB ~ ANO + (1|bloco), data = AGB_outside)
AGB_outside_m2 <- lme4::lmer(scaled_AGB ~ ANO + bloco + (1|bloco), data = AGB_outside)   # best model 
AGB_outside_m3 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + bloco + (1|bloco), data = AGB_outside)   
AGB_outside_m4 <- lme4::lmer(scaled_AGB ~ tratamento + ANO + bloco + (1|bloco), data = AGB_outside) 
AGB_outside_m5 <- lme4::lmer(scaled_AGB ~ tratamento + ANO + (1|bloco), data = AGB_outside)         
AGB_outside_m6 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + (1|bloco), data = AGB_outside) 
AGB_outside_m7 <- lme4::lmer(scaled_AGB ~ tratamento*ANO + (1+Ano|bloco), data = AGB_outside) # isSingular
AIC(AGB_outside_m0, AGB_outside_m1, AGB_outside_m2, AGB_outside_m3, 
    AGB_outside_m4,AGB_outside_m5, AGB_outside_m6, AGB_outside_m7)
```

Exploring residuals

```{r}
par(mfrow=c(1,2))
DHARMa::plotResiduals(AGB_outside_m1)
DHARMa::plotQQunif(AGB_outside_m0)
```

Marginal $R^2$ / Conditional $R^2$

```{r}
MuMIn::r.squaredGLMM(AGB_outside_m1)
0.1505529 /0.1714753
```

0.1505529 /0.1714753 variance explained by fixed effects and by the entire model (around `r 0.1505529 /0.1714753` % is explained by fixed effects)

```{r}
car::Anova(AGB_outside_m5)
```

interaction is no significant at all ($p-value \sim 0.85$)

```{r}
sjPlot::tab_model(AGB_outside_m5)
broom.mixed::tidy(AGB_outside_m5) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))

```


Assessing comparisons:

```{r}
emmeans::emmeans(AGB_outside_m6, pairwise ~ tratamento |ANO) |> multcomp::cld()
```



#### Table S2

Only inside

```{r}
AGB_inside |> 
  dplyr::group_by(ano, tratamento) |>
  dplyr::summarise(
    Mean = round(mean(AGB_sum),2),
    SE = round(sd(AGB_sum)/sqrt(dplyr::n()), 2),
    .groups="drop") |>
  dplyr::mutate(values = paste(Mean, "pm", SE)) |>
  dplyr::select(-c(Mean, SE)) |>
  tidyr::pivot_wider(names_from = tratamento, values_from = values)
```

Increment per year:

```{r}
AGB_inside |>
  dplyr::group_by(tratamento) |>
  dplyr::summarise(
    variacao_media = mean((AGB_sum[ano == 2024] - AGB_sum[ano == 2022])/2),
    desvio_padrao = sd((AGB_sum[ano == 2024] - AGB_sum[ano == 2022])/2),
    erro_padrao = sd((AGB_sum[ano == 2024] - AGB_sum[ano == 2022])/2) / sqrt(dplyr::n()),
    min_variacao = min((AGB_sum[ano == 2024] - AGB_sum[ano == 2022])/2),
    max_variacao = max((AGB_sum[ano == 2024] - AGB_sum[ano == 2022])/2),
    .groups="drop")|>
  dplyr::mutate(slope = paste(round(variacao_media,2), "pm", round(erro_padrao,2)))|>
  dplyr::select(tratamento, slope)
```

Total Aboveground biomass

```{r}
tabS1_agb_total <- AGB_data |> 
  dplyr::group_by(ano, tratamento)|>
  dplyr::summarise(Mean = round(mean(AGB_Mgha),2),
                   SE = round(sd(AGB_Mgha)/sqrt(dplyr::n()), 2),
                   .groups="drop") 
tabS1_agb_total |>
  dplyr::mutate(values = paste(Mean, "pm", SE)) |>
  dplyr::select(-c(Mean, SE)) |>
  tidyr::pivot_wider(names_from = tratamento, values_from = values)

```


Increment per year:

```{r}
AGB_data |>
  dplyr::group_by(tratamento) %>%
  dplyr::summarise(
    variacao_media = mean((AGB_Mgha[ano == 2024] - AGB_Mgha[ano == 2022])/2),
    desvio_padrao = sd((AGB_Mgha[ano == 2024] - AGB_Mgha[ano == 2022])/2),
    erro_padrao = sd((AGB_Mgha[ano == 2024] - AGB_Mgha[ano == 2022])/2) / sqrt(dplyr::n()),
    min_variacao = min((AGB_Mgha[ano == 2024] - AGB_Mgha[ano == 2022])/2),
    max_variacao = max((AGB_Mgha[ano == 2024] - AGB_Mgha[ano == 2022])/2),
    .groups="drop")|>
  dplyr::mutate(slope = paste(round(variacao_media,2), "pm", round(erro_padrao,2)))|>
  dplyr::select(tratamento, slope)
```


#### Figure Biomass 

Percentuals

```{r}
agb_plot_data <-AGB_data0 |> 
  dplyr::group_by(ano, Tratamento, plantio, bloco)|>
  dplyr::summarise(
    AGB_Mgha = sum(AGB_Mgha),
    .groups = "drop") |>
 dplyr::group_by(ano, Tratamento, plantio)|>
    dplyr::summarise(meanAGB = mean(AGB_Mgha),
    sd = sd(AGB_Mgha),
    n = dplyr::n(),
    se = sd/sqrt(n),
    .groups = "drop") |>
  dplyr::mutate(
    Ano = as.factor(ifelse(ano == 2022, "5", "7")),
    Tratamento = forcats::fct_recode(Tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"
                                     ))
max_year <- agb_plot_data |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(meanAGB = max(meanAGB),.groups="drop")|>
  dplyr::group_by(ano)|>
  dplyr::summarise(max_year = max(meanAGB), .groups="drop")
agb_plot_data |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(meanAGB = max(meanAGB),.groups="drop")|>
  dplyr::right_join(max_year, by="ano") |>
  dplyr::mutate(porcentos = round( (meanAGB/max_year)*100, 0))
```


Plotting

```{r, fig.width=3.54, fig.height=3.54}
error_bars <- agb_plot_data |> 
  arrange(Ano, Tratamento, desc(plantio)) |> 
  group_by(Ano, Tratamento) |>
  mutate(meanAGB_new = cumsum(meanAGB)) |>
  ungroup()
porcentos <- data.frame(
  Ano = rep(c("5", "7"), each = 5),  
  Tratamento = rep(unique(agb_plot_data$Tratamento), times = length(unique(agb_plot_data$Ano))),
  meanAGB = c(8, 9, 12, 15, 27, 12, 17, 23, 25, 38),
  label = c(c("17%","27%", "39%", "46%", "100%",
              "21%", "34%", "52%", "53%", "100%"))
  )
text_data <- data.frame(
  Ano = rep(c("5", "7"), each = 5),  
  Tratamento = rep(unique(agb_plot_data$Tratamento), times = length(unique(agb_plot_data$Ano))),
  meanAGB = c(10, 11, 14, 17, 29, 14, 19, 25, 27, 40),
  label = c(c("a","a", "a", "a", "b",
              "A", "AB", "B", "B", "C"))
  )
fig_biomass<-agb_plot_data |>
  ggplot(aes(x = Ano, y = meanAGB, fill = plantio)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(data=error_bars,
                aes(ymin = meanAGB_new - se, ymax = meanAGB_new + se),
                width = .3) +
  scale_fill_manual(
    labels = c('Planted', 'Unplanted'), 
    values = c("#92D050", "white")
    ) +
  labs(fill = "", 
       y =  expression("Total aboveground biomass (Mg.ha"^{-1} ~")"),
       x = "") +
  facet_grid(.~Tratamento, switch = "both")+
  geom_text(data = text_data, aes(x = Ano, y = meanAGB, label = label), size = 3, color = "black", inherit.aes = FALSE) +
  geom_text(data = porcentos, aes(x = Ano, y = meanAGB, label = label), size = 3, color = "black", inherit.aes = FALSE) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,43))+
  ggthemes::theme_clean()+
  theme(
    #plot.margin = margin(b = 0, l = 0),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(color="black", hjust = 1, size=10),
    axis.text.y = element_text(color="black", size=9),
    axis.title.y = element_text(color="black", size=11),
    strip.text = element_text(color="black", hjust = 0.5, size=10),
    panel.spacing = unit(0.1, "mm"),
    strip.placement = "outside",
    legend.text = element_text(size = 11),
    legend.title = element_blank(),
    legend.key.size = unit(3, "mm"),
    legend.box.background = element_blank(),
    legend.box.margin = margin(t = 5, r = 0, b = 0, l = 0, "mm"),
    legend.background = element_blank(), 
    legend.margin = margin(0,0,0,0),
    legend.position = c(0.18, 0.90)
  )
fig_biomass
# ggsave("fig_biomass.png", plot=fig_biomass, width=90, height = 90 ,unit="mm")
```




# II. Results - LiDAR 

Canopy Height Metric (`CHM_mean`, `CHM_SD`, and `CHM_CV`), Canopy cover (`Canopy_cover`), Rugosity (`Rugosity_SD`, and `Rugosity_CV`), Leaf Area Index (`LAI_mean`, `LAI_SD`, and `LAI_CV`), and LAIunder (`LAIunder_mean`, `LAIunder_SD`, `LAIunder_CV`).

### a) Canopy Height Model

2022

```{r}
CHM2022 <- lidar_wide |>
  dplyr::filter(ano==2022)|>
  with(lme4::lmer(CHM_mean ~ Tratamento + (1|Bloco) ) )
par(mfrow=c(1,2))
DHARMa::plotResiduals(CHM2022)
DHARMa::plotQQunif(CHM2022)
```


2024


```{r}
CHM2024 <- lidar_wide |>
  dplyr::filter(ano==2024)|>
  with(lme4::lmer(CHM_mean ~ Tratamento + (1|Bloco) ) )
par(mfrow=c(1,2))
DHARMa::plotResiduals(CHM2024)
DHARMa::plotQQunif(CHM2024)
```

Together

```{r}
modeloCHM <- lidar_wide |>
  with(lme4::lmer(CHM_mean ~ Tratamento*ano + (1|Bloco) ) )
par(mfrow=c(1,2))
DHARMa::plotResiduals(modeloCHM)
DHARMa::plotQQunif(modeloCHM)
```

Comparing estimated means

```{r}
emmeans::emmeans(modeloCHM, pairwise ~ Tratamento | ano) |> multcomp::cld()
```

Comparing estimated slopes


```{r}
emmeans::emtrends(modeloCHM, pairwise ~ Tratamento, var = "ano", poly.trend = TRUE)|> multcomp::cld()
```


Comparing fixed and random factors variance

```{r}
MuMIn::r.squaredGLMM(modeloCHM)
0.7002626  /0.8728069
```

Results:

The trend of variation around the mean CHM was the same over time among treatments (n.s.). The significant differences ($p<0.001$) observed between the 100% planting treatment and the other treatments in 2022 persisted in 2024.


```{r}
sjPlot::tab_model(modeloCHM)
broom.mixed::tidy(modeloCHM) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))
```


#### Table S2

Values per year

```{r}
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = round(mean(CHM_mean), 2),
                   SE = round(sd(CHM_mean)/sqrt(dplyr::n()), 2)) |>
  dplyr::mutate(values = paste(Mean, "pm", SE)) |>
  dplyr::select(-c(Mean, SE)) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```

"Slope" (increment/year)

```{r}
lidar_wide |>
  dplyr::group_by(Tratamento, ano) |>
  dplyr::summarise(
    media = mean(CHM_mean, na.rm = TRUE),
    se = sd(CHM_mean, na.rm = TRUE) / sqrt(dplyr::n()),
    .groups = "drop"
  ) |>
  tidyr::pivot_wider(
    names_from = ano,
    values_from = c(media, se),
    names_sep = "_"
  ) |>
  dplyr::mutate(
    variacao_media = round((media_2024 - media_2022) / 2, 2),
    SE_variacao = round(sqrt(se_2022^2 + se_2024^2) / 2, 2)) |>
  dplyr::mutate(values = paste(variacao_media, "pm", SE_variacao)) |>
  dplyr::select(Tratamento, values) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```


### b) Canopy cover

```{r}
lidar_wide |>
  dplyr::group_by(ano)|>
  dplyr::summarise(mean(Canopy_cover),
                   min(Canopy_cover),
                   max(Canopy_cover),
                   sd(Canopy_cover))

  
```

2022

```{r}
CC2022 <- lidar_wide |>
  dplyr::filter(ano==2022)|>
  with( glmmTMB::glmmTMB(Canopy_cover ~ Tratamento + (1|Bloco)) )
CC2022a <- lidar_wide |>
  dplyr::filter(ano==2022)|>
  with(glmmTMB::glmmTMB(Canopy_cover/100 ~ Tratamento + (1 | Bloco),
                        family = glmmTMB::beta_family()))
AIC(CC2022, CC2022a)
par(mfrow=c(2,2))
DHARMa::plotResiduals(CC2022a)
DHARMa::plotQQunif(CC2022a)
DHARMa::plotResiduals(CC2022)
DHARMa::plotQQunif(CC2022)
```

2024

```{r}
CC2024 <- lidar_wide |>
  dplyr::filter(ano==2024) |>
  with(lme4::lmer(Canopy_cover ~ Tratamento + (1|Bloco) ) )
CC2024a <- lidar_wide |>
  dplyr::filter(ano==2024) |>
  with(glmmTMB::glmmTMB(Canopy_cover/100 ~ Tratamento + (1 | Bloco),
                        family = glmmTMB::beta_family()))
AIC(CC2024, CC2024a)
par(mfrow=c(2,2))
DHARMa::plotResiduals(CC2024a)
DHARMa::plotQQunif(CC2024a)
DHARMa::plotResiduals(CC2024)
DHARMa::plotQQunif(CC2024)

```

models

```{r}
modeloCC <- lidar_wide |>
  with(lme4::lmer(Canopy_cover ~ Tratamento*ano + (1|Bloco) ) )

modeloCCa <- lidar_wide |>
  with(glmmTMB::glmmTMB(Canopy_cover/100 ~ Tratamento*ano + (1 | Bloco),
                        family = glmmTMB::beta_family()))
par(mfrow=c(2,2))
DHARMa::plotResiduals(modeloCC)
DHARMa::plotQQunif(modeloCC)
DHARMa::plotResiduals(modeloCCa)
DHARMa::plotQQunif(modeloCCa)
```

1 outlier

Estimated means

```{r}
emmeans::emmeans(modeloCC, pairwise ~ Tratamento | ano) |> multcomp::cld()
```

Estimated slopes

```{r}
emmeans::emtrends(modeloCC, pairwise ~ Tratamento, var = "ano", poly.trend = TRUE)|> multcomp::cld()
```

Comparing random and fixed effects

```{r}
MuMIn::r.squaredGLMM(modeloCC)
0.469023 / 0.6387404
```

```{r}
sjPlot::tab_model(modeloCC)
broom.mixed::tidy(modeloCC) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))

```



#### Table S2

per year

```{r}
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = round(mean(Canopy_cover), 2),
                   SE = round((sd(Canopy_cover)/sqrt(dplyr::n())), 2),
                   .groups = "drop") |>
  dplyr::mutate(values = paste(Mean, "pm", SE)) |>
  dplyr::select(-c(Mean, SE)) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```

"Slope" (increment/year)

```{r}
lidar_wide |>
  dplyr::group_by(Tratamento, ano) |>
  dplyr::summarise(
    media = mean(Canopy_cover, na.rm = TRUE),
    se = sd(Canopy_cover, na.rm = TRUE) / sqrt(dplyr::n()),
    .groups = "drop"
  ) |>
  tidyr::pivot_wider(
    names_from = ano,
    values_from = c(media, se),
    names_sep = "_"
  ) |>
  dplyr::mutate(
    variacao_media = round((media_2024 - media_2022) / 2, 2),
    SE_variacao = round(sqrt(se_2022^2 + se_2024^2) / 2, 2)) |>
  dplyr::mutate(values = paste(variacao_media, "pm", SE_variacao)) |>
  dplyr::select(Tratamento, values) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```


### c) variance of Canopy cover

Performing a pairwise comparison of variances is not as straightforward as comparing means, but you can use specific statistical techniques to compare variances between treatment groups. Here's how you can do this in R:

```{r}
pairwise_levene <- function(data, response, group) {
  treatment_pairs <- combn(unique(data[[group]]), 2, simplify = FALSE)
  p_values <- vector("list", length(treatment_pairs))
  
  for (i in seq_along(treatment_pairs)) { #i =1
    subset_data <- data[data[[group]] %in% treatment_pairs[[i]], ]
    test_result <- leveneTest(subset_data[[response]] ~ subset_data[[group]])
    p_values[[i]] <- test_result[1, "Pr(>F)"]
  }
  
  comparison <- sapply(treatment_pairs, function(x) paste(x, collapse = " vs "))
  results <- data.frame(Comparison = comparison, P_Value = unlist(p_values))
  results$Adjusted_P_Value <- p.adjust(results$P_Value, method = "bonferroni")
  
  return(results)
}

pairwise_levene(lidar2022_wide , "Canopy_cover", "Tratamento")
pairwise_levene(lidar2024_wide , "Canopy_cover", "Tratamento")
```


#### Table S2 (Rugosity)

```{r}
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = round(mean(Rugosity_SD),2),
                   SE = round((sd(Rugosity_SD)/sqrt(dplyr::n())), 2),
                   .groups="drop") |>
  dplyr::mutate(values = paste(Mean, "pm", SE)) |>
  dplyr::select(-c(Mean, SE)) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```

Increment/year

```{r}
lidar_wide |>
  dplyr::group_by(Tratamento, ano) |>
  dplyr::summarise(
    media = mean(Rugosity_SD, na.rm = TRUE),
    se = sd(Rugosity_SD, na.rm = TRUE) / sqrt(dplyr::n()),
    .groups = "drop"
  ) |>
  tidyr::pivot_wider(
    names_from = ano,
    values_from = c(media, se),
    names_sep = "_"
  ) |>
  dplyr::mutate(
    variacao_media = round((media_2024 - media_2022) / 2, 2),
    SE_variacao = round(sqrt(se_2022^2 + se_2024^2) / 2, 2)) |>
  dplyr::mutate(values = paste(variacao_media, "pm", SE_variacao)) |>
  dplyr::select(Tratamento, values) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```

### d) LAI Mean

2022

```{r}
LAI2022 <- lidar_wide |>
  dplyr::filter(ano==2022) |>
  with(lme4::lmer(LAI_mean ~ Tratamento + (1|Bloco) ) )
par(mfrow=c(1,2))
DHARMa::plotResiduals(LAI2022)
DHARMa::plotQQunif(LAI2022)
```

2024

```{r}
LAI2024 <- lidar_wide |>
  dplyr::filter(ano==2024) |>
  with(lme4::lmer(LAI_mean ~ Tratamento + (1|Bloco) ) )
par(mfrow=c(1,2))
DHARMa::plotResiduals(LAI2024)
DHARMa::plotQQunif(LAI2024)
```

Full model

```{r}
modeloLAI <- lidar_wide |>
  with(lme4::lmer(LAI_mean ~ Tratamento * ano + (1 | Bloco)))
par(mfrow=c(1,2))
DHARMa::plotResiduals(modeloLAI)
DHARMa::plotQQunif(modeloLAI)
```

Pairwise comparison

```{r}
emmeans::emmeans(modeloLAI, pairwise ~ Tratamento | ano) |> multcomp::cld()
```

Trend:

```{r}
emmeans::emtrends(modeloLAI, pairwise ~ Tratamento, var = "ano", poly.trend = TRUE)|> multcomp::cld()
```

Fixed vs random

```{r}
MuMIn::r.squaredGLMM(modeloLAI)
0.7064328 /0.8459851
```

```{r}
sjPlot::tab_model(modeloLAI)
broom.mixed::tidy(modeloLAI) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 3)))
```



#### Table S2

```{r}
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = round(mean(LAI_mean),2),
                   SE = round((sd(LAI_mean)/sqrt(dplyr::n())), 2), 
                   .groups = "drop") |>
  dplyr::mutate(values = paste(Mean, "pm", SE)) |>
  dplyr::select(-c(Mean, SE)) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```

Increment/year (slope)

```{r}
lidar_wide |>
  dplyr::group_by(Tratamento, ano) |>
  dplyr::summarise(
    media = mean(LAI_mean, na.rm = TRUE),
    se = sd(LAI_mean, na.rm = TRUE) / sqrt(dplyr::n()),
    .groups = "drop"
  ) |>
  tidyr::pivot_wider(
    names_from = ano,
    values_from = c(media, se),
    names_sep = "_"
  ) |>
  dplyr::mutate(
    variacao_media = round((media_2024 - media_2022) / 2, 2),
    SE_variacao = round(sqrt(se_2022^2 + se_2024^2) / 2, 2)) |>
  dplyr::mutate(values = paste(variacao_media, "pm", SE_variacao)) |>
  dplyr::select(Tratamento, values) |>
  tidyr::pivot_wider(names_from = Tratamento, values_from = values)
```


### e) Figure - LiDAR

#### (i) Canopy height model (CHM)

```{r}
max_year <- lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(CHM_mean),.groups="drop") |>
  dplyr::group_by(ano)|>
  dplyr::summarise(max_year = max(Mean),.groups="drop")
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(CHM_mean),.groups="drop") |>
  dplyr::right_join(max_year, by="ano") |>
  dplyr::mutate(porcentos = round( (Mean/max_year)*100, 0))
```

Plot


```{r fig5a, fig.width=3.2}
letras <- data.frame(
  Tratamento = rep(levels(as.factor(lidar_wide$Tratamento)),each=2),
  ano = c(2022, 2024),
  label = c("A      ","       a",
            "A      ","       a", 
            "A      ","       b",
            "A      ","       b",
            "B      ","       c"),
  y = c(2.8, 3.9, 
        3.1, 4.5, 
        3.9, 5.7, 
        3.9, 5.7, 
        5.9, 7.8)  )
porcentos <- data.frame(
  Tratamento = rep(levels(as.factor(lidar_wide$Tratamento)),each=2),
  ano = c(2022, 2024),
  label = c("39%        ","          39%",
            "43%        ","          45%",
            "61%        ","          67%",
            "60%        ","          63%",
            "100%         ","          100%"),  
  y = c(2.2, 3.1, 
        2.5, 3.7, 
        3.3, 5, 
        3.3, 5, 
        5.3, 7.1)            
)
p1 <- lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(CHM_mean),
                   SD = sd(CHM_mean),
                   SE = SD/sqrt(dplyr::n()),
                   .groups="drop") |>
  ggplot(aes(x = Tratamento, y = Mean, fill = as.factor(ano))) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(
    labels = c('5 years', '7 years'), 
    values = c("#CAF0F8", "#00B4D8")) +
  geom_text(data = letras, aes(x = Tratamento, y = y, label = label),size = 3.5, color="black", vjust = -0.5) +
  geom_text(data = porcentos, aes(x = Tratamento, y = y, label = label),size = 3, color="black", vjust = -0.5) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 9), breaks = seq(0, 8, by = 1))+
  labs(fill = "", 
       y =  "Canopy height model (m)",
       x = "") +
  theme_classic()+
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_text(color="black", size=9),
      axis.title.y = element_text(color="black", size=10),
      legend.position = c(0.15, 0.9),
      legend.text = element_text(size = 10),
      legend.key.size = unit(3, "mm"),
      plot.margin = margin(t=5, 0, 0, 0, "mm"))
p1
```



#### (ii) Canopy cover

```{r}
max_year <- lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(Canopy_cover),.groups="drop") |>
  dplyr::group_by(ano)|>
  dplyr::summarise(max_year = max(Mean),.groups="drop")
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(Canopy_cover),.groups="drop") |>
  dplyr::right_join(max_year, by="ano") |>
  dplyr::mutate(porcentos = round( (Mean/max_year)*100, 0))
```

plot

```{r fig5b, fig.width=3.2}
letras <- data.frame(
  Tratamento = rep(levels(as.factor(lidar_wide$Tratamento)),each=2),
  ano = c(2022, 2024),
  label = c("A     ","       a",
            "A     ","       a", 
            "A     ","      ab",
            "A     ","      ab",
            "B     ","       b"),  
  y = c(52, 77, 
        40, 65, 
        40, 85, 
        45, 90, 
        97, 109)            
)
porcentos <- data.frame(
  Tratamento = rep(levels(as.factor(lidar_wide$Tratamento)),each=2),
  ano = c(2022, 2024),
  label = c("40%        ","          59%",
            "30%        ","          46%",
            "33%        ", "         74%",
            "40%        ","          73%",
            "100%         ","          100%"),  
  y = c(42, 67, 
        30, 55, 
        30, 75, 
        35, 80, 
        87, 100)  
)
p2 <- lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(Canopy_cover),
                   SD = sd(Canopy_cover),
                   SE = SD/sqrt(dplyr::n()),
                   .groups="drop") |>
  ggplot(aes(x = Tratamento, y = Mean, fill = as.factor(ano))) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(
    labels = c('5 years', '7 years'), 
    values = c("#CAF0F8", "#00B4D8")) +
  geom_text(data = letras, aes(x = Tratamento, y = y, label = label),size = 3.5, color="black", vjust = -0.5) +
  geom_text(data = porcentos, aes(x = Tratamento, y = y, label = label),size = 3, color="black", vjust = -0.5) +
    scale_y_continuous(expand = c(0, 0), limits=c(0, 120), breaks = seq(0, 100, by = 20))+
  labs(fill = "", 
       y =  "Canopy cover (%)",
       x = "") +
  theme_classic()+
    theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=10),
    plot.margin = margin(t=5, 0, 0, 0, "mm"),
    legend.position = 'none')
p2
```


#### (iii) LAI

```{r}
max_year <- lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(LAI_mean),.groups="drop") |>
  dplyr::group_by(ano)|>
  dplyr::summarise(max_year = max(Mean),.groups="drop")
lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(LAI_mean),.groups="drop") |>
  dplyr::right_join(max_year, by="ano") |>
  dplyr::mutate(porcentos = round( (Mean/max_year)*100, 0))
```

Plot

```{r fig5c, fig.width=3.2}
letras <- data.frame(
  Tratamento = rep(levels(as.factor(lidar_wide$Tratamento)),each=2),
  ano = c(2022, 2024),
  label = c("A       ","       a",
            "A       ","      ab",
            "A       ", "      b",
            "A       ","      ab",
            "B       ","       c"),  
  y = c( 0.85, 1.4, 
         1.05, 1.55, 
         1.15, 1.82, 
         1.25, 1.82, 
         2.05, 2.9)
  ) |>
  dplyr::mutate(
    Tratamento = forcats::fct_recode(Tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"
                                     )
  )

porcentos <- data.frame(
  Tratamento = rep(levels(as.factor(lidar_wide$Tratamento)),each=2),
  ano = c(2022, 2024),
  label = c("29%        ","          37%",
            "38%       ","          43%",
            "50%       ","          57%",
            "53%       ","          56%",
            "100%          ","        100%"),  
  y = c( 0.55, 1.1, 
         0.75, 1.25, 
         0.85, 1.52, 
         0.95, 1.52, 
         1.75, 2.65)
  )|>
  dplyr::mutate(
    Tratamento = forcats::fct_recode(Tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"
                                     )
  )

p3 <- lidar_wide |>
  dplyr::group_by(ano, Tratamento)|>
  dplyr::summarise(Mean = mean(LAI_mean),
                   SD = sd(LAI_mean),
                   SE = SD/sqrt(dplyr::n()),
                   .groups="drop") |>
  dplyr::mutate(
    Tratamento = forcats::fct_recode(Tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"))|>
  ggplot(aes(x = Tratamento, y = Mean, fill = as.factor(ano))) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(
    labels = c('5 years', '7 years'), 
    values = c("#CAF0F8", "#00B4D8")) +
  geom_text(data = letras, aes(x = Tratamento, y = y, label = label),size = 3.5, color="black", vjust = -0.5) +
  geom_text(data = porcentos, aes(x = Tratamento, y = y, label = label),size = 3, color="black", vjust = -0.5) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,3.2), breaks = seq(0, 3, by=1))+
  labs(fill = "", 
       y =  expression("LAI (m"^{2} ~ "/ m"^{2}~ ")"),
       x = "") +
  theme_classic()+
  theme(
    axis.text.x = element_text(color="black", hjust = 0.5, size=10),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=10),
    plot.margin = margin(t=5, 0, 0, 0, "mm"),
    legend.position = 'none')

p3
```


#### (iv) All together

```{r fig5, fig.height=8.26, fig.width=3.54}
# 90 mm x 180 mm
fig_lidar <- cowplot::plot_grid(p1,p2,p3, ncol = 1,align = "v", axis = "l",
       labels = c("(a)", "(b)", "(c)"), label_size = 10, label_x = 0.01, label_y = 1)

fig_lidar
# ggsave("fig_lidar.png", plot=fig_lidar, width=90, height = 210 ,unit="mm")
```

**capital letters**: 5 years

**small letters**: 7 years


# III. Results - Costs


## A) Cost per unit (Biomass and Canopy coverage)

Table of Costs (in R$)

```{r}
costs <- data.frame(
  tratamento = c("Planting 100%",	"Strips 50%",	"Nuclei 50%",	"Strips 25%",	"Nuclei 25%"),
  labor_machinery =  c(7860.00, 6407.90, 7563.90, 5131.05, 6395.23),
  inputs = c(7032.50, 4096.25, 4096.25, 2628.13, 2628.13)) |>
  dplyr::mutate(total = labor_machinery + inputs)
```


### Using raw values

```{r}
cover_raw <- lidar_wide |> 
  dplyr::select(ano, Bloco, Tratamento, Canopy_cover) |>
  dplyr::rename(bloco = Bloco, tratamento = Tratamento) |>
  dplyr::mutate(tratamento = ordered(tratamento, 
                                     levels = c("Nuclei 25%", "Strips 25%", "Nuclei 50%", "Strips 50%", "Planting 100%")),
                bloco = ordered(bloco, levels = c("BI","BII", "BIII", "BIV", "BV")),
                bloco = as.character(as.numeric(bloco)))|>
  dplyr::left_join(costs) |>
  dplyr::mutate(totalUS = (total/5)/5.8)


cost_raw <- AGB_data |> 
  dplyr::select(ano, bloco, tratamento, AGB_Mgha) |> 
  dplyr::mutate(
    tratamento = dplyr::case_when(
      tratamento == "100" ~ "Planting 100%",
      tratamento == "F25" ~ "Strips 25%",
      tratamento == "F50" ~ "Strips 50%",
      tratamento == "N25" ~ "Nuclei 25%",
      tratamento == "N50" ~ "Nuclei 50%"
    )
    ) |>
  dplyr::right_join(cover_raw) |>
  dplyr::mutate(agb_cost = totalUS/AGB_Mgha,
                cc_cost = totalUS/Canopy_cover,
                ano = ano-2017) |>
  dplyr::select(ano:tratamento, agb_cost, cc_cost)
```

#### (i) Tests

```{r}
modeloCC_cost <- lme4::lmer(log(cc_cost) ~ tratamento*ano + (1|bloco), data=cost_raw) 
par(mfrow=c(1,2))
DHARMa::plotResiduals(modeloCC_cost)
DHARMa::plotQQunif(modeloCC_cost)
emmeans::emmeans(modeloCC_cost, pairwise ~ tratamento | ano) |> multcomp::cld()
```


```{r}
sjPlot::tab_model(modeloCC_cost)
broom.mixed::tidy(modeloCC_cost) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), round, 3)) 
```



```{r}
modeloAGB_cost <- lme4::lmer(log(agb_cost) ~ tratamento*ano + (1|bloco), data=cost_raw ) 
par(mfrow=c(1,2))
DHARMa::plotResiduals(modeloAGB_cost)
DHARMa::plotQQunif(modeloAGB_cost)
emmeans::emmeans(modeloAGB_cost, pairwise ~ tratamento | ano) |> multcomp::cld()
```


And the slopes?


```{r}
emmeans::emtrends(modeloCC_cost, pairwise ~ tratamento, var = "ano", poly.trend = TRUE)|> multcomp::cld()
```


```{r}
emmeans::emtrends(modeloAGB_cost, pairwise ~ tratamento, var = "ano", poly.trend = TRUE)|> multcomp::cld()
```


```{r}
sjPlot::tab_model(modeloAGB_cost)
broom.mixed::tidy(modeloAGB_cost) |> dplyr::mutate(dplyr::across(dplyr::where(is.numeric), round, 3)) 
```


#### (ii) Figure Cost-effectiveness

```{r, fig.width=3.2, fig.height=4.3}
fig_data_cost_raw <- cost_raw |>
  dplyr::group_by(ano, tratamento)|>
  dplyr::summarise(
    cost_cc = mean(cc_cost),
    SE_cc = sd(cc_cost)/sqrt(dplyr::n()),
    cost_agb = mean(agb_cost),
    SE_agb = sd(agb_cost)/sqrt(dplyr::n()), 
    .groups="drop")|>
  dplyr::mutate(tratamento = ordered(tratamento, levels = c("Nuclei 25%", "Strips 25%", "Nuclei 50%", "Strips 50%", "Planting 100%")),
                tratamento = forcats::fct_recode(tratamento,
                                     "Nuclei\n25%" = "Nuclei 25%",
                                     "Strips\n25%" = "Strips 25%",
                                     "Nuclei\n50%" = "Nuclei 50%",
                                     "Strips\n50%" = "Strips 50%",
                                     "Planting\n100%" = "Planting 100%"
                                     ))
```


```{r, fig.width=3.2, fig.height=2.15}
letras <- data.frame(
  tratamento = rep(levels(as.factor(fig_data_cost_raw$tratamento)), each=2),
  ano = c(5, 7),
  label = c("B      ","        a",
            "AB      ","       a", 
            "AB      ","       a",
            "AB      ","       a",
            "A      ","       a"),
  y = c(33, 16, 
        18, 10, 
        18, 8, 
        18, 10, 
        10, 6))

fig_cost1 <- fig_data_cost_raw |>
  ggplot(aes(x = tratamento, y = cost_cc, fill = as.factor(ano))) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = cost_cc - SE_cc, ymax = cost_cc + SE_cc), width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(
    labels = c('5 years', '7 years'), 
    values = c("#CAF0F8", "#00B4D8")) +
  geom_text(data = letras, aes(x = tratamento, y = y, label = label), size = 3.5, color="black", vjust = -0.5) +
  scale_y_continuous(expand=c(0,0), limits=c(0,38), breaks = c(0, 10,20, 30))+
  labs(fill = "",
       y = expression("CE Canopy cover (" * "\u0024" * ".%"^{-1} * ")"),
       x = "") +
  theme_classic()+
    theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color="black", size=10),
    axis.title.y = element_text(color="black", size=10),
    plot.margin = margin(t=5, 0, 0, 0, "mm"),
    legend.position = c(0.85, 0.95))

fig_cost1
```


```{r, fig.width=3.2, fig.height=2.15}
letras <- data.frame(
  tratamento = rep(levels(as.factor(fig_data_cost_raw$tratamento)), each=2),
  ano = c(5, 7),
  label = c("B     ","       b",
            "A     ","      a", 
            "AB    ","     ab",
            "A     ","     ab",
            "A     ","      a"),
  y = c(210, 100, 53, 25, 53, 30, 53, 33, 30, 20)            
)


fig_cost2 <- fig_data_cost_raw |>
  ggplot(aes(x = tratamento, y = cost_agb, fill = as.factor(ano))) +
  geom_bar(position = position_dodge2(preserve = "single"), 
           stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = cost_agb - SE_agb, ymax = cost_agb + SE_agb), 
                width = .2, position = position_dodge(0.9)) +
  scale_fill_manual(
    labels = c('5 years', '7 years'), 
    values = c("#CAF0F8", "#00B4D8")) +
  geom_text(data = letras, aes(x = tratamento, y = y, label = label), size = 3.5, color="black", vjust = -0.5) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 240), breaks = c(0,50,100, 150, 200))+
  labs(fill = "",
       y = expression("CE AGB (" * "\u0024" * ".Mg"^{-1} * ")"),
       x = "") +
  theme_classic()+
    theme(
    axis.line.x = element_line(color = "black", linewidth = 0.8, linetype = "solid"),
    axis.line.y = element_line(color = "black", linewidth = 0.8, linetype = "solid"),
    axis.ticks = element_line(color = "black", linewidth = 0.5),
    axis.text.x = element_text(color="black", hjust = .5, size=10),
    axis.text.y = element_text(color="black", size=10),
    legend.position = 'none',
    axis.title.y = element_text(color="black", size=10))
fig_cost2
```


```{r, fig.width=3.2, fig.height=4.3}
fig_cost <- cowplot::plot_grid(fig_cost1, fig_cost2, ncol = 1,
                               align = "v", axis = "l",
                               labels = c("(a)", "(b)"), label_size = 8, 
                               label_x = 0.05, label_y = c(1,1.1))
fig_cost
# ggsave("fig_cost.png", plot=fig_cost, width=90, height = 120 ,unit="mm")
```


#### (iii) Table Cost-effectiveness


```{r}
fig_data_cost_raw |>
  dplyr::mutate(dplyr::across(where(is.numeric), ~ round(.x, 2))) 
```

